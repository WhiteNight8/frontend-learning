# çŠ¶æ€ç®¡ç†ä¸æ¶æ„è®¾è®¡ 

## Pinia çš„å†…éƒ¨å®ç°åŸç†åŠå…¶ç›¸â½ Vuex çš„æ¶æ„ä¼˜åŠ¿ 

### Pinia çš„æ ¸å¿ƒå®ç°åŸç†

Pinia æ˜¯ Vue çš„å®˜æ–¹çŠ¶æ€ç®¡ç†åº“ï¼Œè®¾è®¡ä¸º Vuex çš„åç»§è€…ï¼Œå…¶æ ¸å¿ƒå®ç°åŸºäº Vue 3 çš„ç»„åˆå¼ API å’Œå“åº”å¼ç³»ç»Ÿï¼š



```js
// Pinia çš„ç®€åŒ–æ ¸å¿ƒå®ç°
function createPinia() {
  // ä½¿ç”¨ Vue 3 çš„å“åº”å¼ API åˆ›å»ºå…±äº«çŠ¶æ€
  const state = reactive({});
  
  // å­˜å‚¨æ‰€æœ‰æ³¨å†Œçš„ store
  const _stores = {};
  
  return {
    install(app) {
      app.provide(piniaSymbol, pinia);
    },
    use(plugin) {
      // æ’ä»¶ç³»ç»Ÿ
    },
    state,
    _stores
  };
}

// åˆ›å»º Store çš„ç®€åŒ–å®ç°
function defineStore(id, options) {
  return function useStore() {
    const pinia = inject(piniaSymbol);
    
    // é¿å…é‡å¤åˆ›å»º
    if (!pinia._stores[id]) {
      // åˆ›å»º store å®ä¾‹
      const store = reactive({});
      
      // å¤„ç† state
      const initialState = options.state ? options.state() : {};
      pinia.state[id] = reactive(initialState);
      
      // æ·»åŠ  getters
      for (const getterName in options.getters) {
        const getter = options.getters[getterName];
        // ä½¿ç”¨è®¡ç®—å±æ€§
        store[getterName] = computed(() => getter.call(store, store));
      }
      
      // æ·»åŠ  actions
      for (const actionName in options.actions) {
        const action = options.actions[actionName];
        store[actionName] = function() {
          return action.apply(store, arguments);
        };
      }
      
      // å°† state ä»£ç†åˆ° store ä¸Š
      Object.defineProperty(store, '$state', {
        get: () => pinia.state[id],
        set: (newState) => {
          pinia.state[id] = newState;
        }
      });
      
      pinia._stores[id] = store;
    }
    
    return pinia._stores[id];
  };
}
```



### Pinia ç›¸æ¯” Vuex çš„æ¶æ„ä¼˜åŠ¿

1. æ›´ç®€æ´çš„ API è®¾è®¡ï¼š
   - ç§»é™¤äº† Mutationsï¼Œç›´æ¥ä½¿ç”¨ Actions ä¿®æ”¹çŠ¶æ€
   - å»é™¤åµŒå¥—æ¨¡å—çš„å¤æ‚ç»“æ„ï¼Œæ¯ä¸ª Store ç‹¬ç«‹å­˜åœ¨
   - ç®€åŒ–äº†çŠ¶æ€çš„è®¿é—®å’Œä¿®æ”¹æ–¹å¼
2. æ›´å¥½çš„ TypeScript æ”¯æŒï¼š
   - è‡ªåŠ¨ç±»å‹æ¨å¯¼ï¼Œä¸éœ€è¦å¤æ‚çš„ç±»å‹å£°æ˜
   - API è®¾è®¡æ›´ç¬¦åˆç±»å‹ç³»ç»Ÿçš„å·¥ä½œæ–¹å¼
   - æ›´å‹å¥½çš„ IDE è‡ªåŠ¨å®Œæˆå’Œç±»å‹æ£€æŸ¥
3. åŸºäºç»„åˆå¼ APIï¼š
   - ä¸ Vue 3 ç»„åˆå¼ API å®Œç¾å¥‘åˆ
   - æ›´å¥½çš„ä»£ç ç»„ç»‡å’Œé€»è¾‘å¤ç”¨
   - ä¸å†éœ€è¦æ³¨å…¥è¾…åŠ©å‡½æ•°ï¼ˆå¦‚ mapStateã€mapGettersï¼‰
4. æ›´å¥½çš„å¼€å‘ä½“éªŒï¼š
   - æ›´æ˜“äºè°ƒè¯•ï¼ŒçŠ¶æ€ç»“æ„æ›´åŠ æ‰å¹³
   - ä¸å†éœ€è¦å‘½åç©ºé—´æ¥é¿å…å‘½åå†²çª
   - æ›´è½»é‡çº§ï¼Œçº¦ 1KB (minzip)
5. æ›´å¼ºçš„å¯æ‰©å±•æ€§ï¼š
   - ç®€åŒ–çš„æ’ä»¶ç³»ç»Ÿ
   - æ”¯æŒ Hot Module Replacement
   - æ›´å®¹æ˜“ä¸å…¶ä»–åº“é›†æˆ



```js
// Vuex çš„ Store å®šä¹‰
const store = new Vuex.Store({
  state: {
    count: 0
  },
  mutations: {
    increment(state) {
      state.count++
    }
  },
  actions: {
    asyncIncrement({ commit }) {
      setTimeout(() => {
        commit('increment')
      }, 1000)
    }
  },
  getters: {
    doubleCount(state) {
      return state.count * 2
    }
  }
})

// Pinia çš„ Store å®šä¹‰
const useCounterStore = defineStore('counter', {
  state: () => ({ count: 0 }),
  actions: {
    increment() {
      this.count++
    },
    async asyncIncrement() {
      setTimeout(() => {
        this.count++
      }, 1000)
    }
  },
  getters: {
    doubleCount: (state) => state.count * 2
  }
})
```



## å¦‚ä½•åŸºäº Pinia è®¾è®¡â¼¤å‹åº”â½¤çš„çŠ¶æ€ç®¡ç†æ¶æ„

### çŠ¶æ€åˆ†å±‚ç­–ç•¥

åœ¨å¤§å‹åº”ç”¨ä¸­ï¼ŒPinia çŠ¶æ€ç®¡ç†æ¶æ„é€šå¸¸å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ å±‚ï¼š

1. **åº”ç”¨çº§çŠ¶æ€**ï¼šå…¨å±€é…ç½®ã€ä¸»é¢˜ã€ç”¨æˆ·ä¿¡æ¯ç­‰
2. **ä¸šåŠ¡é¢†åŸŸçŠ¶æ€**ï¼šæŒ‰åŠŸèƒ½æ¨¡å—åˆ’åˆ†çš„çŠ¶æ€
3. **é¡µé¢çº§çŠ¶æ€**ï¼šç‰¹å®šé¡µé¢å†…çš„çŠ¶æ€
4. **ç»„ä»¶çº§çŠ¶æ€**ï¼šå¯å¤ç”¨ç»„ä»¶çš„å†…éƒ¨çŠ¶æ€

```
src/
â””â”€â”€ stores/
    â”œâ”€â”€ index.js                 # ä¸»å…¥å£ï¼Œå¯¼å‡ºæ‰€æœ‰ store
    â”œâ”€â”€ user.js                  # ç”¨æˆ·ç›¸å…³çŠ¶æ€
    â”œâ”€â”€ app.js                   # åº”ç”¨å…¨å±€çŠ¶æ€
    â”œâ”€â”€ modules/                 # æŒ‰æ¨¡å—åˆ†ç»„
    â”‚   â”œâ”€â”€ products/
    â”‚   â”‚   â”œâ”€â”€ index.js         # äº§å“æ¨¡å—ä¸»å…¥å£
    â”‚   â”‚   â”œâ”€â”€ products.js      # äº§å“åˆ—è¡¨çŠ¶æ€
    â”‚   â”‚   â””â”€â”€ product-details.js  # äº§å“è¯¦æƒ…çŠ¶æ€
    â”‚   â””â”€â”€ orders/
    â”‚       â”œâ”€â”€ index.js         # è®¢å•æ¨¡å—ä¸»å…¥å£
    â”‚       â”œâ”€â”€ orders.js        # è®¢å•åˆ—è¡¨çŠ¶æ€
    â”‚       â””â”€â”€ order-details.js # è®¢å•è¯¦æƒ…çŠ¶æ€
    â””â”€â”€ helpers/                 # è¾…åŠ©å‡½æ•°å’Œå·¥å…·
        â”œâ”€â”€ store-factory.js     # Store å·¥å‚å‡½æ•°
        â””â”€â”€ persistence.js       # çŠ¶æ€æŒä¹…åŒ–å·¥å…·src/

```

### ä»£ç å®ç°èŒƒä¾‹

**ä¸»å…¥å£ (index.js)**:

```js
// src/stores/index.js
import { createPinia } from 'pinia'
import { piniaPluginPersist } from './plugins/persist'

const pinia = createPinia()
pinia.use(piniaPluginPersist)

export default pinia
```

**åº”ç”¨çŠ¶æ€ (app.js)**:

```js
// src/stores/app.js
import { defineStore } from 'pinia'

export const useAppStore = defineStore('app', {
  state: () => ({
    theme: 'light',
    sidebar: {
      opened: true,
      withoutAnimation: false
    },
    device: 'desktop',
    size: 'medium'
  }),
  
  actions: {
    toggleSidebar() {
      this.sidebar.opened = !this.sidebar.opened
    },
    closeSidebar() {
      this.sidebar.opened = false
    },
    toggleDevice(device) {
      this.device = device
    },
    setSize(size) {
      this.size = size
    },
    setTheme(theme) {
      this.theme = theme
    }
  },
  
  persist: {
    enabled: true,
    strategies: [
      {
        key: 'app-settings',
        storage: localStorage,
        paths: ['theme', 'size']
      }
    ]
  }
})
```

**ä¸šåŠ¡æ¨¡å—çŠ¶æ€ (products.js)**:

```js
// src/stores/modules/products/products.js
import { defineStore } from 'pinia'
import { fetchProducts, searchProducts } from '@/api/products'

export const useProductsStore = defineStore('products', {
  state: () => ({
    items: [],
    loading: false,
    error: null,
    filters: {
      category: null,
      price: { min: 0, max: null },
      search: ''
    },
    pagination: {
      page: 1,
      limit: 20,
      total: 0
    }
  }),
  
  getters: {
    filteredProducts: (state) => {
      // è¿”å›è¿‡æ»¤åçš„äº§å“åˆ—è¡¨
      return state.items.filter(/* è¿‡æ»¤é€»è¾‘ */)
    },
    productById: (state) => (id) => {
      return state.items.find(product => product.id === id)
    }
  },
  
  actions: {
    async fetchProducts() {
      this.loading = true
      try {
        const { data, pagination } = await fetchProducts({
          page: this.pagination.page,
          limit: this.pagination.limit,
          ...this.filters
        })
        this.items = data
        this.pagination.total = pagination.total
        this.error = null
      } catch (error) {
        this.error = error.message
      } finally {
        this.loading = false
      }
    },
    
    async searchProducts(query) {
      this.filters.search = query
      this.pagination.page = 1 // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
      return this.fetchProducts()
    },
    
    setFilter(filter, value) {
      this.filters[filter] = value
    },
    
    resetFilters() {
      this.filters = {
        category: null,
        price: { min: 0, max: null },
        search: ''
      }
    }
  }
})
```

### Store ä¹‹é—´çš„é€šä¿¡ä¸ä¾èµ–

åœ¨å¤§å‹åº”ç”¨ä¸­ï¼ŒStore ä¹‹é—´å¯èƒ½éœ€è¦ç›¸äº’é€šä¿¡ï¼š

```js
// è´­ç‰©è½¦ä¾èµ–äº§å“çš„ç¤ºä¾‹
import { defineStore } from 'pinia'
import { useProductsStore } from './products'

export const useCartStore = defineStore('cart', {
  state: () => ({
    items: [] // è´­ç‰©è½¦é¡¹ï¼ŒåŒ…å« productId å’Œ quantity
  }),
  
  getters: {
    cartProducts() {
      const productsStore = useProductsStore()
      return this.items.map(cartItem => {
        const product = productsStore.productById(cartItem.productId)
        return {
          ...product,
          quantity: cartItem.quantity
        }
      })
    },
    
    total() {
      return this.cartProducts.reduce((total, item) => {
        return total + (item.price * item.quantity)
      }, 0)
    }
  },
  
  actions: {
    addToCart(productId, quantity = 1) {
      const existingItem = this.items.find(item => item.productId === productId)
      
      if (existingItem) {
        existingItem.quantity += quantity
      } else {
        this.items.push({ productId, quantity })
      }
    },
    
    removeFromCart(productId) {
      const index = this.items.findIndex(item => item.productId === productId)
      if (index > -1) {
        this.items.splice(index, 1)
      }
    }
  }
})
```

### ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»ºç›¸ä¼¼çš„ Store

å¯¹äºéœ€è¦åˆ›å»ºå¤šä¸ªç±»ä¼¼ç»“æ„çš„ Storeï¼ˆå¦‚åˆ—è¡¨é¡µé¢çš„çŠ¶æ€ç®¡ç†ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å·¥å‚å‡½æ•°ï¼š

```js
// src/stores/helpers/list-store-factory.js
import { defineStore } from 'pinia'

export function createListStore(options) {
  const {
    id,
    fetchItems,
    defaultFilters = {},
    defaultPagination = { page: 1, limit: 20 }
  } = options
  
  return defineStore(id, {
    state: () => ({
      items: [],
      loading: false,
      error: null,
      filters: { ...defaultFilters },
      pagination: { ...defaultPagination, total: 0 }
    }),
    
    actions: {
      async load() {
        this.loading = true
        try {
          const { data, pagination } = await fetchItems({
            ...this.filters,
            page: this.pagination.page,
            limit: this.pagination.limit
          })
          this.items = data
          this.pagination.total = pagination.total
          this.error = null
        } catch (error) {
          this.error = error.message
        } finally {
          this.loading = false
        }
      },
      
      setFilter(key, value) {
        this.filters[key] = value
        this.pagination.page = 1 // é‡ç½®åˆ†é¡µ
      },
      
      setPage(page) {
        this.pagination.page = page
      }
    }
  })
}

// ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»º Store
// src/stores/modules/products/products.js
import { createListStore } from '@/stores/helpers/list-store-factory'
import { fetchProducts } from '@/api/products'

export const useProductsStore = createListStore({
  id: 'products',
  fetchItems: fetchProducts,
  defaultFilters: {
    category: null,
    status: 'active'
  }
})
```



## ä»æºç â»†åº¦åˆ†æ Pinia çš„å“åº”å¼é›†æˆä¸ TypeScript â½€æŒ 

### Pinia çš„å“åº”å¼å®ç°

Pinia ç›´æ¥åˆ©ç”¨äº† Vue 3 çš„å“åº”å¼ç³»ç»Ÿï¼Œå…¶æ ¸å¿ƒæºç ä¸­çš„å…³é”®éƒ¨åˆ†ï¼š

```ts
// ç®€åŒ–çš„ createPinia æºç 
export function createPinia(): Pinia {
  const scope = effectScope(true)
  // state æ˜¯ä½¿ç”¨ effectScope åˆ›å»ºçš„å“åº”å¼å¯¹è±¡
  const state = scope.run(() => ref<Record<string, StateTree>>({}))!

  // ...å…¶ä»–ä»£ç ...

  const pinia: Pinia = {
    install(app: App) {
      // å°† pinia å®ä¾‹æä¾›ç»™åº”ç”¨
      app.provide(piniaSymbol, pinia)
      app.config.globalProperties.$pinia = pinia
    },
    use(plugin) {
      plugins.push(plugin)
      return this
    },
    _p: plugins,
    _a: app,
    _e: scope,
    _s: new Map<string, StoreGeneric>(),
    state,
  }

  return pinia
}

// ç®€åŒ–çš„ defineStore æºç 
export function defineStore<
  Id extends string,
  S extends StateTree = {},
  G extends _GettersTree<S> = {},
  A = {}
>(
  idOrOptions: Id | DefineStoreOptions<Id, S, G, A>,
  setup?: Setup<Id, S, G, A>
): StoreDefinition<Id, S, G, A> {
  let id: Id
  let options: DefineStoreOptions<Id, S, G, A>

  // å¤„ç†å‚æ•°...

  function useStore(): StoreGeneric {
    // è·å–å½“å‰ç»„ä»¶å®ä¾‹ä¸Šä¸‹æ–‡
    const currentInstance = getCurrentInstance()
    // è·å– pinia å®ä¾‹
    let pinia: Pinia | undefined = currentInstance && inject(piniaSymbol)

    // åˆ›å»º store å®ä¾‹...
    const store = createSetupStore(
      id,
      setup,
      options,
      pinia,
      hot,
      isUseStore
    )

    return store as any
  }

  useStore.$id = id

  return useStore
}

// åˆ›å»º setup store çš„å…³é”®å®ç°
function createSetupStore<Id extends string>(
  id: Id,
  setup: () => SS,
  options: DefineSetupStoreOptions<Id, SS> = {},
  pinia: Pinia,
  hot?: boolean,
  isUseStore?: boolean
): Store<Id, SS> {
  // ä½¿ç”¨ effectScope åˆ›å»ºç‹¬ç«‹çš„å“åº”å¼ä½œç”¨åŸŸ
  const scope = effectScope()

  // åœ¨ä½œç”¨åŸŸå†…è¿è¡Œ setup å‡½æ•°ï¼Œè·å– store çš„åˆå§‹çŠ¶æ€å’Œæ–¹æ³•
  const setupStore = scope.run(() => setup())!

  // åˆ›å»ºå“åº”å¼ store å¯¹è±¡
  const store = reactive({
    _p: pinia,
    _s: scope,
    $id: id,
    // ...å…¶ä»–å±æ€§å’Œæ–¹æ³•
  }) as Store<Id, SS>

  // å°† setupStore çš„å±æ€§å’Œæ–¹æ³•æ··åˆåˆ° store å¯¹è±¡ä¸­
  for (const key in setupStore) {
    const prop = setupStore[key]
    
    // å¤„ç† refã€computed å’Œæ™®é€šå€¼çš„æƒ…å†µ
    if (isRef(prop) && !isComputed(prop)) {
      // å¯¹äº refï¼Œé€æ˜åœ°ä»£ç†åˆ° state
    } else if (typeof prop === 'function') {
      // å¯¹äºå‡½æ•°ï¼ˆactionsï¼‰ï¼Œç»‘å®š this ä¸Šä¸‹æ–‡
    } else {
      // å…¶ä»–æƒ…å†µç›´æ¥èµ‹å€¼
    }
  }

  // è¿”å›å“åº”å¼ store
  return store
}
```

è¿™äº›æºç ç‰‡æ®µå±•ç¤ºäº† Pinia å¦‚ä½•åˆ©ç”¨ Vue 3 çš„ `reactive`ã€`ref`ã€`computed` å’Œ `effectScope` ç­‰ API æ¥å®ç°çŠ¶æ€ç®¡ç†çš„å“åº”å¼ç‰¹æ€§ã€‚

### TypeScript æ”¯æŒçš„å®ç°

Pinia çš„ TypeScript æ”¯æŒä¸»è¦é€šè¿‡æ³›å‹å’Œç±»å‹æ¨å¯¼å®ç°ï¼š

```ts
// å®šä¹‰ Store ç±»å‹çš„ç®€åŒ–ç¤ºä¾‹
export interface StoreGeneric {
  $id: string
  $state: Record<string, any>
  $patch(partialState: Record<string, any>): void
  $reset(): void
  $dispose(): void
  // ...å…¶ä»–æ–¹æ³•
}

// Store çš„ç±»å‹å®šä¹‰
export interface Store<
  Id extends string = string,
  S extends StateTree = StateTree,
  G = _GettersTree<S>,
  A = {}
> extends StoreGeneric {
  $id: Id
  $state: S
  $getters: G
  // ...å…¶ä»–ç‰¹æ€§
}

// defineStore çš„ç±»å‹å®šä¹‰
export function defineStore<
  Id extends string,
  S extends StateTree,
  G extends _GettersTree<S>,
  A
>(
  id: Id,
  options: DefineStoreOptions<Id, S, G, A>
): StoreDefinition<Id, S, G, A>

export function defineStore<
  Id extends string,
  S extends StateTree = {},
  G extends _GettersTree<S> = {},
  A = {}
>(
  id: Id,
  storeSetup: () => SS,
  options?: DefineSetupStoreOptions<Id, SS>
): StoreDefinition<Id, TakenState, TakenGetters, TakenActions>

// ä½¿ç”¨ç»„åˆå¼ API çš„ Store å®šä¹‰ç±»å‹
export interface DefineStoreOptionsBase<S extends StateTree, Store> {
  state?: () => S
  getters?: _GettersTree<S> & ThisType<Store>
  actions?: _ActionsTree & ThisType<Store>
}
```

Pinia çš„ç±»å‹ç³»ç»Ÿæ”¯æŒä»¥ä¸‹ç‰¹æ€§ï¼š

1. **è‡ªåŠ¨ç±»å‹æ¨å¯¼**ï¼šä» Store å®šä¹‰ä¸­è‡ªåŠ¨æ¨å¯¼å‡º stateã€getters å’Œ actions çš„ç±»å‹
2. **ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥**ï¼šç¡®ä¿ Store æ“ä½œçš„ç±»å‹å®‰å…¨
3. **ThisType å·¥å…·ç±»å‹**ï¼šç¡®ä¿åœ¨ getters å’Œ actions ä¸­çš„ `this` ä¸Šä¸‹æ–‡æ­£ç¡®
4. **æ³›å‹æ”¯æŒ**ï¼šå…è®¸çµæ´»å®šä¹‰å„ç§ç±»å‹çš„ Store

```ts
// ä½¿ç”¨ TypeScript å®šä¹‰ Store
const useUserStore = defineStore('user', {
  state: () => ({
    name: '',
    isAdmin: false,
    preferences: {
      theme: 'light' as 'light' | 'dark',
      notifications: true
    }
  }),
  
  getters: {
    fullName: (state) => `${state.name} (${state.isAdmin ? 'Admin' : 'User'})`,
    // ä½¿ç”¨ this è®¿é—®å…¶ä»– getters
    greeting(): string {
      return `Hello, ${this.fullName}!`
    }
  },
  
  actions: {
    async fetchUser(id: string) {
      // TypeScript ä¼šæ£€æŸ¥ this.name çš„ç±»å‹
      this.name = await api.fetchUserName(id)
    },
    toggleTheme() {
      // TypeScript ç¡®ä¿ theme åªèƒ½æ˜¯ 'light' æˆ– 'dark'
      this.preferences.theme = this.preferences.theme === 'light' ? 'dark' : 'light'
    }
  }
})

// ä½¿ç”¨ç»„åˆå¼ API å®šä¹‰ Store
const useCounterStore = defineStore('counter', () => {
  // state
  const count = ref(0)
  const name = ref('Counter')
  
  // getters
  const doubleCount = computed(() => count.value * 2)
  
  // actions
  function increment() {
    count.value++
  }
  
  function setName(newName: string) {
    name.value = newName
  }
  
  return { count, name, doubleCount, increment, setName }
})
```





## Pinia æ’ä»¶ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç° 

### æ’ä»¶ç³»ç»ŸåŸºæœ¬åŸç†

Pinia çš„æ’ä»¶ç³»ç»Ÿå…è®¸æ‰©å±• Store çš„åŠŸèƒ½ã€‚æ’ä»¶é€šè¿‡æ¥æ”¶ Store ä¸Šä¸‹æ–‡å¹¶ä¿®æ”¹æˆ–å¢å¼ºå®ƒæ¥å·¥ä½œï¼š

```ts
// ç®€åŒ–çš„æ’ä»¶ç±»å‹å®šä¹‰
export type PiniaPlugin = (
  context: PiniaPluginContext
) => void | Partial<PiniaCustomProperties>

export interface PiniaPluginContext<
  Id extends string = string,
  S extends StateTree = StateTree,
  G = _GettersTree<S>,
  A = _ActionsTree
> {
  pinia: Pinia
  app: App
  store: Store<Id, S, G, A>
  options: DefineStoreOptions<Id, S, G, A>
}

// æ’ä»¶æ³¨å†Œæœºåˆ¶
export function createPinia() {
  const pinia = {
    // ...å…¶ä»–å±æ€§
    use(plugin) {
      plugins.push(plugin)
      return this
    }
  }
  
  return pinia
}

// åœ¨ store åˆ›å»ºè¿‡ç¨‹ä¸­åº”ç”¨æ’ä»¶
function createStore(id, options, pinia) {
  // åˆ›å»ºåŸºæœ¬ store...
  
  // åº”ç”¨æ’ä»¶
  pinia._p.forEach((plugin) => {
    if (Array.isArray(plugin)) {
      plugin[0]({ store, options, pinia }, plugin[1])
    } else {
      plugin({ store, options, pinia })
    }
  })
  
  return store
}
```

### æ’ä»¶å¼€å‘ç¤ºä¾‹

**æ—¥å¿—æ’ä»¶**ï¼š

```js
// plugins/logger.js
export function piniaLogger({ store }) {
  // ä¿å­˜åŸå§‹ actions
  const actions = {}
  for (const action in store.$options.actions) {
    actions[action] = store[action]
    
    // é‡å†™ actionï¼Œæ·»åŠ æ—¥å¿—
    store[action] = function(...args) {
      console.log(`[ğŸ ${store.$id}] ${action} å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°:`, args)
      
      const startTime = Date.now()
      const result = actions[action].apply(this, args)
      
      // å¤„ç† Promise ç»“æœ
      if (result instanceof Promise) {
        return result.then(r => {
          console.log(`[ğŸ ${store.$id}] ${action} æ‰§è¡Œå®Œæˆï¼Œè€—æ—¶: ${Date.now() - startTime}ms`)
          return r
        }).catch(error => {
          console.error(`[ğŸ ${store.$id}] ${action} æ‰§è¡Œå‡ºé”™:`, error)
          throw error
        })
      }
      
      console.log(`[ğŸ ${store.$id}] ${action} æ‰§è¡Œå®Œæˆï¼Œè€—æ—¶: ${Date.now() - startTime}ms`)
      return result
    }
  }
  
  // ç›‘å¬çŠ¶æ€å˜åŒ–
  store.$subscribe((mutation, state) => {
    console.log(`[ğŸ ${store.$id}] çŠ¶æ€æ›´æ–°:`, mutation.type, mutation.payload)
  })
}

// ä½¿ç”¨æ’ä»¶
import { createPinia } from 'pinia'
import { piniaLogger } from './plugins/logger'

const pinia = createPinia()
pinia.use(piniaLogger)
```

**å…¨å±€å±æ€§æ’ä»¶**ï¼š

```js
// plugins/api.js
import { api } from '../api'

export function piniaApiPlugin({ store }) {
  // ä¸ºæ¯ä¸ª store æ·»åŠ  $api å±æ€§
  return {
    $api: api
  }
}

// ä½¿ç”¨å…¨å±€å±æ€§
import { defineStore } from 'pinia'

export const useUserStore = defineStore('user', {
  state: () => ({
    user: null
  }),
  actions: {
    async fetchUser(id) {
      // ä½¿ç”¨æ’ä»¶æ·»åŠ çš„ $api å±æ€§
      this.user = await this.$api.users.get(id)
    }
  }
})
```

**çŠ¶æ€æŒä¹…åŒ–æ’ä»¶**ï¼š

```js
// plugins/persist.js
import { watch } from 'vue'

export function piniaPersistPlugin({ store, options }) {
  // æ£€æŸ¥æ˜¯å¦å¯ç”¨æŒä¹…åŒ–
  if (!options.persist) return
  
  const {
    key = store.$id,
    storage = localStorage,
    paths = null
  } = typeof options.persist === 'object' ? options.persist : {}
  
  // åˆå§‹åŒ–æ—¶ä» storage æ¢å¤çŠ¶æ€
  try {
    const savedState = storage.getItem(key)
    if (savedState) {
      store.$patch(JSON.parse(savedState))
    }
  } catch (error) {
    console.error(`[ğŸ Persist] Failed to restore state for "${store.$id}":`, error)
  }
  
  // ç›‘å¬çŠ¶æ€å˜åŒ–å¹¶ä¿å­˜åˆ° storage
  watch(
    () => store.$state,
    (state) => {
      try {
        // å¦‚æœæŒ‡å®šäº†è·¯å¾„ï¼Œåªä¿å­˜ç‰¹å®šçš„çŠ¶æ€å­—æ®µ
        const saveState = paths
          ? Object.fromEntries(
              paths.map(path => {
                // æ”¯æŒåµŒå¥—è·¯å¾„å¦‚ 'user.profile.email'
                const value = path.split('.').reduce((obj, key) => obj[key], state)
                return [path, value]
              })
            )
          : state
          
        storage.setItem(key, JSON.stringify(saveState))
      } catch (error) {
        console.error(`[ğŸ Persist] Failed to save state for "${store.$id}":`, error)
      }
    },
    { deep: true }
  )
}

// ä½¿ç”¨æŒä¹…åŒ–æ’ä»¶
import { defineStore } from 'pinia'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    token: null,
    user: null
  }),
  // é…ç½®æŒä¹…åŒ–
  persist: {
    key: 'auth-store',
    storage: localStorage,
    paths: ['token'] // åªæŒä¹…åŒ– token
  }
})
```



## çŠ¶æ€æŒä¹…åŒ–ã€çŠ¶æ€åŒæ­¥ç­‰â¾¼çº§åŠŸèƒ½çš„å®ç°â½…æ¡ˆ 

### çŠ¶æ€æŒä¹…åŒ–å®ç°

åŸºäº Pinia æ’ä»¶ç³»ç»Ÿå®ç°å®Œæ•´çš„çŠ¶æ€æŒä¹…åŒ–æ–¹æ¡ˆï¼š

```js
// plugins/persist.js
import { watch } from 'vue'
import { toRaw } from '@vue/reactivity'

export const piniaPluginPersist = ({ store, options }) => {
  // é»˜è®¤æŒä¹…åŒ–é…ç½®
  const defaultPersist = {
    enabled: false,
    strategies: []
  }
  
  // åˆå¹¶é…ç½®
  const persist = Object.assign(defaultPersist, options.persist || {})
  
  // å¦‚æœæœªå¯ç”¨ï¼Œåˆ™ç›´æ¥è¿”å›
  if (!persist.enabled) return
  
  // æ¢å¤çŠ¶æ€
  const restoreState = () => {
    persist.strategies.forEach(strategy => {
      const { key = store.$id, storage = localStorage, paths = null } = strategy
      
      try {
        const fromStorage = storage.getItem(key)
        if (fromStorage) {
          const savedState = JSON.parse(fromStorage)
          
          // å¦‚æœæŒ‡å®šäº†è·¯å¾„ï¼Œåªæ¢å¤è¿™äº›è·¯å¾„ä¸‹çš„çŠ¶æ€
          if (paths) {
            const partialState = {}
            paths.forEach(path => {
              // æ”¯æŒç‚¹åˆ†éš”çš„è·¯å¾„
              const pathParts = path.split('.')
              let currentStorageVal = savedState
              let currentStateTarget = partialState
              
              // é€çº§åˆ›å»ºç›®æ ‡å¯¹è±¡ç»“æ„
              for (let i = 0; i < pathParts.length; i++) {
                const part = pathParts[i]
                
                if (i === pathParts.length - 1) {
                  // æœ€åä¸€çº§ï¼Œç›´æ¥èµ‹å€¼
                  currentStateTarget[part] = currentStorageVal[part]
                } else {
                  // ä¸­é—´çº§åˆ«ï¼Œåˆ›å»ºå¯¹è±¡
                  if (!currentStorageVal[part]) break
                  currentStorageVal = currentStorageVal[part]
                  
                  if (!currentStateTarget[part]) {
                    currentStateTarget[part] = {}
                  }
                  currentStateTarget = currentStateTarget[part]
                }
              }
            })
            
            // ä½¿ç”¨åˆå¹¶çš„æ–¹å¼åº”ç”¨çŠ¶æ€
            store.$patch(partialState)
          } else {
            // å¦‚æœæ²¡æœ‰æŒ‡å®šè·¯å¾„ï¼Œæ¢å¤æ•´ä¸ªçŠ¶æ€
            store.$patch(savedState)
          }
        }
      } catch (error) {
        console.error(`[Pinia Persist] Failed to restore state for "${store.$id}" from ${key}:`, error)
      }
    })
  }
  
  // ä¿å­˜çŠ¶æ€
  const saveState = () => {
    persist.strategies.forEach(strategy => {
      const { key = store.$id, storage = localStorage, paths = null } = strategy
      
      try {
        // è·å–åŸå§‹çŠ¶æ€ï¼ˆé¿å…å“åº”å¼ä»£ç†å¯¹è±¡ï¼‰
        const state = toRaw(store.$state)
        
        // æ ¹æ®è·¯å¾„è¿‡æ»¤çŠ¶æ€
        const saveState = paths
          ? paths.reduce((saveState, path) => {
              // å¤„ç†åµŒå¥—è·¯å¾„
              const pathParts = path.split('.')
              let currentSourceObj = state
              let currentTargetObj = saveState
              
              for (let i = 0; i < pathParts.length; i++) {
                const part = pathParts[i]
                
                if (i === pathParts.length - 1) {
                  // æœ€åä¸€çº§ï¼Œä¿å­˜å€¼
                  currentTargetObj[part] = currentSourceObj[part]
                } else {
                  // ä¸­é—´çº§åˆ«
                  if (currentSourceObj[part] === undefined) break
                  
                  if (!currentTargetObj[part]) {
                    currentTargetObj[part] = {}
                  }
                  
                  currentSourceObj = currentSourceObj[part]
                  currentTargetObj = currentTargetObj[part]
                }
              }
              
              return saveState
            }, {})
          : state
        
        // ä¿å­˜åˆ°å­˜å‚¨
        storage.setItem(key, JSON.stringify(saveState))
      } catch (error) {
        console.error(`[Pinia Persist] Failed to save state for "${store.$id}" to ${key}:`, error)
      }
    })
  }
  
  // åˆå§‹åŒ–æ—¶æ¢å¤çŠ¶æ€
  restoreState()
  
  // ç›‘å¬çŠ¶æ€å˜åŒ–å¹¶ä¿å­˜
  watch(
    () => store.$state,
    () => {
      saveState()
    },
    { deep: true }
  )
  
  // ä¸º store æ·»åŠ æ‰‹åŠ¨æŒä¹…åŒ–æ–¹æ³•
  return {
    persist: {
      save: saveState,
      restore: restoreState
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
// src/stores/auth.js
import { defineStore } from 'pinia'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    token: null,
    user: {
      id: null,
      name: null,
      email: null,
      preferences: {
        theme: 'light',
        notifications: true
      }
    }
  }),
  
  actions: {
    setToken(token) {
      this.token = token
    },
    
    setUser(user) {
      this.user = user
    },
    
    logout() {
      this.token = null
      this.user = {
        id: null,
        name: null,
        email: null,
        preferences: {
          theme: 'light',
          notifications: true
        }
      }
    }
  },
  
  persist: {
    enabled: true,
    strategies: [
      {
        key: 'auth-token',
        storage: localStorage,
        paths: ['token']
      },
      {
        key: 'user-preferences',
        storage: localStorage,
        paths: ['user.preferences']
      }
    ]
  }
})
```



### è·¨æ ‡ç­¾é¡µçŠ¶æ€åŒæ­¥

å®ç°å¤šæ ‡ç­¾é¡µä¹‹é—´çš„çŠ¶æ€åŒæ­¥ï¼š

```js
// plugins/sync.js
import { watch } from 'vue'
import { toRaw } from '@vue/reactivity'

export const piniaPluginSync = ({ store, options }) => {
  // é»˜è®¤é…ç½®
  const defaultSync = {
    enabled: false,
    eventName: 'pinia-sync',
    stores: []
  }
  
  // åˆå¹¶é…ç½®
  const sync = Object.assign(defaultSync, options.sync || {})
  
  // å¦‚æœæœªå¯ç”¨æˆ–è€…å½“å‰ store ä¸åœ¨åŒæ­¥åˆ—è¡¨ä¸­ï¼Œåˆ™ç›´æ¥è¿”å›
  if (!sync.enabled || (sync.stores.length > 0 && !sync.stores.includes(store.$id))) {
    return
  }
  
  // åˆ›å»ºå”¯ä¸€çš„äº‹ä»¶åç§°ï¼Œé¿å…å†²çª
  const syncEventName = `${sync.eventName}:${store.$id}`
  
  // ç”Ÿæˆå”¯ä¸€çš„æ ‡ç­¾é¡µ ID
  const tabId = Date.now().toString(36) + Math.random().toString(36).substring(2)
  
  // ç›‘å¬çŠ¶æ€å˜åŒ–å¹¶å¹¿æ’­
  watch(
    () => store.$state,
    (state) => {
      // é¿å…æ— é™å¾ªç¯ï¼šæ ‡è®°æ­¤æ¬¡æ›´æ–°ä¸ºæœ¬åœ°å‘èµ·
      const message = {
        tabId,
        storeId: store.$id,
        state: toRaw(state)
      }
      
      localStorage.setItem('pinia-sync-timestamp', Date.now().toString())
      window.dispatchEvent(
        new CustomEvent(syncEventName, { detail: message })
      )
    },
    { deep: true }
  )
  
  // ç›‘å¬å…¶ä»–æ ‡ç­¾é¡µçš„çŠ¶æ€å˜åŒ–
  window.addEventListener(syncEventName, (event) => {
    const { tabId: sourceTabId, storeId, state } = event.detail
    
    // å¿½ç•¥è‡ªå·±å‘å‡ºçš„äº‹ä»¶
    if (sourceTabId === tabId || storeId !== store.$id) {
      return
    }
    
    // åº”ç”¨æ¥è‡ªå…¶ä»–æ ‡ç­¾é¡µçš„çŠ¶æ€
    store.$patch(state)
  })
  
  // å¤„ç† localStorage å˜åŒ–ï¼ˆåœ¨æŸäº›æƒ…å†µä¸‹æ›´å¯é ï¼‰
  window.addEventListener('storage', (event) => {
    if (event.key === 'pinia-sync-timestamp') {
      // å‘é€è¯·æ±‚åŒæ­¥æ¶ˆæ¯
      window.dispatchEvent(
        new CustomEvent(`${sync.eventName}:request`, {
          detail: { tabId, storeIds: [store.$id] }
        })
      )
    }
  })
  
  // å“åº”åŒæ­¥è¯·æ±‚
  window.addEventListener(`${sync.eventName}:request`, (event) => {
    const { tabId: requestTabId, storeIds } = event.detail
    
    // å¿½ç•¥è‡ªå·±çš„è¯·æ±‚
    if (requestTabId === tabId) {
      return
    }
    
    // å¦‚æœè¯·æ±‚åŒ…å«å½“å‰ storeï¼Œåˆ™å‘é€çŠ¶æ€
    if (storeIds.includes(store.$id)) {
      window.dispatchEvent(
        new CustomEvent(syncEventName, {
          detail: {
            tabId,
            storeId: store.$id,
            state: toRaw(store.$state)
          }
        })
      )
    }
  })
  
  // é¡µé¢åŠ è½½æ—¶è¯·æ±‚åŒæ­¥
  window.dispatchEvent(
    new CustomEvent(`${sync.eventName}:request`, {
      detail: { tabId, storeIds: [store.$id] }
    })
  )
}

// ä½¿ç”¨ç¤ºä¾‹
// src/stores/cart.js
import { defineStore } from 'pinia'

export const useCartStore = defineStore('cart', {
  state: () => ({
    items: [],
    couponCode: null
  }),
  
  getters: {
    totalItems: (state) => state.items.reduce((sum, item) => sum + item.quantity, 0),
    totalPrice: (state) => state.items.reduce((sum, item) => sum + item.price * item.quantity, 0)
  },
  
  actions: {
    addItem(product, quantity = 1) {
      const existingItem = this.items.find(item => item.id === product.id)
      
      if (existingItem) {
        existingItem.quantity += quantity
      } else {
        this.items.push({
          id: product.id,
          name: product.name,
          price: product.price,
          quantity
        })
      }
    },
    
    removeItem(productId) {
      const index = this.items.findIndex(item => item.id === productId)
      if (index > -1) {
        this.items.splice(index, 1)
      }
    },
    
    applyCoupon(code) {
      this.couponCode = code
    }
  },
  
  // é…ç½®è·¨æ ‡ç­¾é¡µåŒæ­¥
  sync: {
    enabled: true,
    eventName: 'cart-sync'
  }
})
```



### çŠ¶æ€å†å²è®°å½•ä¸æ’¤é”€/é‡åšåŠŸèƒ½

å®ç°æ’¤é”€/é‡åšåŠŸèƒ½çš„æ’ä»¶ï¼š

```js
// plugins/history.js
import { markRaw } from 'vue'

export const piniaPluginHistory = ({ store, options }) => {
  // é»˜è®¤é…ç½®
  const defaultHistory = {
    enabled: false,
    maxHistory: 10,
    trackProperties: null, // è·Ÿè¸ªæ‰€æœ‰å±æ€§
    ignoreProperties: []   // å¿½ç•¥çš„å±æ€§
  }
  
  // åˆå¹¶é…ç½®
  const history = Object.assign(defaultHistory, options.history || {})
  
  // å¦‚æœæœªå¯ç”¨ï¼Œåˆ™ç›´æ¥è¿”å›
  if (!history.enabled) return
  
  // åˆ›å»ºå†å²è®°å½•å’Œå½“å‰ä½ç½®
  const past = markRaw([])
  const future = markRaw([])
  let ignoreNextChange = false
  
  // åˆ›å»ºå¿«ç…§å‡½æ•°
  const createSnapshot = () => {
    const state = JSON.parse(JSON.stringify(store.$state))
    
    // å¦‚æœæŒ‡å®šäº†è¦è·Ÿè¸ªçš„å±æ€§ï¼Œåªä¿ç•™è¿™äº›å±æ€§
    if (history.trackProperties) {
      const trackedState = {}
      history.trackProperties.forEach(prop => {
        if (state[prop] !== undefined) {
          trackedState[prop] = state[prop]
        }
      })
      return trackedState
    }
    
    // å¦‚æœæŒ‡å®šäº†è¦å¿½ç•¥çš„å±æ€§ï¼Œç§»é™¤è¿™äº›å±æ€§
    if (history.ignoreProperties.length) {
      history.ignoreProperties.forEach(prop => {
        delete state[prop]
      })
    }
    
    return state
  }
  
  // ç›‘å¬çŠ¶æ€å˜åŒ–
  store.$subscribe((_, state) => {
    if (ignoreNextChange) {
      ignoreNextChange = false
      return
    }
    
    // åˆ›å»ºå½“å‰çŠ¶æ€çš„å¿«ç…§å¹¶æ·»åŠ åˆ°å†å²è®°å½•
    past.push(createSnapshot())
    
    // é™åˆ¶å†å²è®°å½•æ•°é‡
    if (past.length > history.maxHistory) {
      past.shift()
    }
    
    // æ¸…ç©ºæœªæ¥è®°å½•ï¼ˆå› ä¸ºæœ‰äº†æ–°çš„å˜æ›´ï¼‰
    future.length = 0
  })
  
  // ä¸º store æ·»åŠ æ’¤é”€/é‡åšæ–¹æ³•
  return {
    // æ’¤é”€å‡½æ•°
    undo() {
      if (past.length === 0) return false
      
      // è·å–ä¸Šä¸€ä¸ªçŠ¶æ€
      const snapshot = past.pop()
      
      // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æœªæ¥è®°å½•
      future.push(createSnapshot())
      
      // åº”ç”¨ä¸Šä¸€ä¸ªçŠ¶æ€
      ignoreNextChange = true
      store.$patch(snapshot)
      
      return true
    },
    
    // é‡åšå‡½æ•°
    redo() {
      if (future.length === 0) return false
      
      // è·å–ä¸‹ä¸€ä¸ªçŠ¶æ€
      const snapshot = future.pop()
      
      // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
      past.push(createSnapshot())
      
      // åº”ç”¨ä¸‹ä¸€ä¸ªçŠ¶æ€
      ignoreNextChange = true
      store.$patch(snapshot)
      
      return true
    },
    
    // æ¸…é™¤å†å²è®°å½•
    clearHistory() {
      past.length = 0
      future.length = 0
    },
    
    // è·å–å†å²è®°å½•çŠ¶æ€
    historyState() {
      return {
        canUndo: past.length > 0,
        canRedo: future.length > 0
      }
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
// src/stores/document.js
import { defineStore } from 'pinia'

export const useDocumentStore = defineStore('document', {
  state: () => ({
    content: '',
    title: '',
    lastSaved: null,
    isModified: false
  }),
  
  actions: {
    updateContent(content) {
      this.content = content
      this.isModified = true
    },
    
    updateTitle(title) {
      this.title = title
      this.isModified = true
    },
    
    save() {
      this.lastSaved = new Date()
      this.isModified = false
    }
  },
  
  // é…ç½®å†å²è®°å½•
  history: {
    enabled: true,
    maxHistory: 50,
    trackProperties: ['content', 'title'], // åªè·Ÿè¸ªå†…å®¹å’Œæ ‡é¢˜
    ignoreProperties: ['lastSaved', 'isModified'] // å¿½ç•¥è¿™äº›å±æ€§
  }
})

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const documentStore = useDocumentStore()

// æ’¤é”€æŒ‰é’®
const handleUndo = () => {
  documentStore.undo()
}

// é‡åšæŒ‰é’®
const handleRedo = () => {
  documentStore.redo()
}

// è·å–å†å²çŠ¶æ€æ¥æ›´æ–° UI
const historyState = computed(() => documentStore.historyState())
```





## Pinia åœ¨ SSR åœºæ™¯ä¸­çš„åº”â½¤ä¸æ³¨æ„äº‹é¡¹ 

### SSR ä¸­çš„çŠ¶æ€ç®¡ç†æŒ‘æˆ˜

åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰åœºæ™¯ä¸­ä½¿ç”¨ Pinia é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

1. **çŠ¶æ€éš”ç¦»**ï¼šæ¯ä¸ªè¯·æ±‚éœ€è¦ç‹¬ç«‹çš„çŠ¶æ€
2. **æ•°æ®é¢„å–**ï¼šéœ€è¦åœ¨æœåŠ¡ç«¯é¢„å–æ•°æ®å¹¶å¡«å……åˆ° store ä¸­
3. **çŠ¶æ€åºåˆ—åŒ–**ï¼šéœ€è¦å°†æœåŠ¡ç«¯çŠ¶æ€ä¼ é€’åˆ°å®¢æˆ·ç«¯
4. **çŠ¶æ€æ¿€æ´»**ï¼šå®¢æˆ·ç«¯éœ€è¦æ¥ç®¡æœåŠ¡ç«¯çš„çŠ¶æ€å¹¶ä½¿å…¶å…·æœ‰å“åº”æ€§

### Pinia åœ¨ SSR ä¸­çš„åŸºæœ¬ä½¿ç”¨

```js
// server.js
import { createPinia } from 'pinia'
import { createSSRApp } from 'vue'
import { renderToString } from '@vue/server-renderer'
import { createRouter } from 'vue-router'
import App from './App.vue'

export async function render(url, manifest) {
  // ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºæ–°çš„åº”ç”¨å®ä¾‹å’Œ pinia
  const app = createSSRApp(App)
  const pinia = createPinia()
  const router = createRouter(/* é…ç½® */)
  
  app.use(pinia)
  app.use(router)
  
  // è®¾ç½®æœåŠ¡å™¨è¯·æ±‚ URL
  await router.push(url)
  await router.isReady()
  
  // è·å–åŒ¹é…çš„è·¯ç”±ç»„ä»¶
  const matchedComponents = router.currentRoute.value.matched
    .flatMap(record => Object.values(record.components))
  
  // å¦‚æœç»„ä»¶å®ç°äº† serverPrefetchï¼Œåˆ™é¢„å–æ•°æ®
  try {
    await Promise.all(matchedComponents.map(Component => {
      if (Component.serverPrefetch) {
        return Component.serverPrefetch()
      }
    }))
  } catch (error) {
    // å¤„ç†é¢„å–é”™è¯¯
  }
  
  // æ¸²æŸ“åº”ç”¨
  const html = await renderToString(app)
  
  // åºåˆ—åŒ– Pinia çŠ¶æ€
  const state = JSON.stringify(pinia.state.value)
  
  return { html, state }
}

// client.js
import { createPinia } from 'pinia'
import { createApp } from 'vue'
import App from './App.vue'

const app = createApp(App)
const pinia = createPinia()

app.use(pinia)

// å¦‚æœæœ‰åˆå§‹çŠ¶æ€ï¼Œåˆ™æ¿€æ´»å®ƒ
if (window.__INITIAL_STATE__) {
  pinia.state.value = JSON.parse(window.__INITIAL_STATE__)
}

app.mount('#app')
```

### åœ¨ç»„ä»¶ä¸­å®ç°æ•°æ®é¢„å–

```vue
<!-- UserProfile.vue -->
<template>
  <div v-if="userStore.loaded">
    <h1>{{ userStore.user.name }}</h1>
    <p>{{ userStore.user.email }}</p>
  </div>
  <div v-else>åŠ è½½ä¸­...</div>
</template>

<script>
import { defineComponent } from 'vue'
import { useUserStore } from '../stores/user'

export default defineComponent({
  name: 'UserProfile',
  
  // åœ¨æœåŠ¡ç«¯é¢„å–æ•°æ®
  async serverPrefetch() {
    const userStore = useUserStore()
    return userStore.fetchUser(this.$route.params.id)
  },
  
  setup() {
    const userStore = useUserStore()
    
    // åœ¨å®¢æˆ·ç«¯ï¼Œå¦‚æœæ•°æ®å°šæœªåŠ è½½ï¼Œåˆ™è·å–æ•°æ®
    if (!userStore.loaded) {
      userStore.fetchUser(this.$route.params.id)
    }
    
    return {
      userStore
    }
  }
})
</script>
```

### å¤„ç†æœåŠ¡ç«¯ç‰¹æœ‰çš„ API è°ƒç”¨

```js
// stores/user.js
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useUserStore = defineStore('user', () => {
  const user = ref(null)
  const error = ref(null)
  const loaded = ref(false)
  
  const isLoggedIn = computed(() => !!user.value)
  
  async function fetchUser(id) {
    // é‡ç½®çŠ¶æ€
    error.value = null
    
    try {
      // ç¯å¢ƒç‰¹å®šçš„ API è°ƒç”¨
      let userData
      
      if (import.meta.env.SSR) {
        // æœåŠ¡ç«¯ API è°ƒç”¨ï¼ˆå¯ä»¥ç›´æ¥è®¿é—®æ•°æ®åº“æˆ–å†…éƒ¨ APIï¼‰
        const { getUser } = await import('../server/db')
        userData = await getUser(id)
      } else {
        // å®¢æˆ·ç«¯ API è°ƒç”¨
        const response = await fetch(`/api/users/${id}`)
        userData = await response.json()
      }
      
      user.value = userData
      loaded.value = true
    } catch (err) {
      error.value = err.message
    }
  }
  
  return {
    user,
    error,
    loaded,
    isLoggedIn,
    fetchUser
  }
})
```

### SSR ä¸­çš„çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ

1. **é¿å…åœ¨ Store ä¸­ä½¿ç”¨æµè§ˆå™¨ API**ï¼š

```js
// ä¸è¦è¿™æ ·åš
const useUiStore = defineStore('ui', {
  state: () => ({
    windowWidth: window.innerWidth, // æœåŠ¡ç«¯æ²¡æœ‰ window å¯¹è±¡
    theme: localStorage.getItem('theme') || 'light' // æœåŠ¡ç«¯æ²¡æœ‰ localStorage
  })
})

// æ­£ç¡®åšæ³•
const useUiStore = defineStore('ui', {
  state: () => ({
    windowWidth: 0,
    theme: 'light'
  }),
  
  actions: {
    init() {
      // åªåœ¨å®¢æˆ·ç«¯æ‰§è¡Œ
      if (import.meta.env.SSR) return
      
      this.windowWidth = window.innerWidth
      this.theme = localStorage.getItem('theme') || 'light'
      
      window.addEventListener('resize', () => {
        this.windowWidth = window.innerWidth
      })
    }
  }
})

// åœ¨åº”ç”¨æŒ‚è½½ååˆå§‹åŒ–
app.mount('#app')
uiStore.init()
```

1. **ä½¿ç”¨å ä½ç¬¦çŠ¶æ€**ï¼š

```js
// stores/articles.js
import { defineStore } from 'pinia'

export const useArticlesStore = defineStore('articles', {
  state: () => ({
    list: [],
    loading: false,
    loadingPlaceholders: Array(5).fill().map((_, i) => ({
      id: `placeholder-${i}`,
      title: '',
      isPlaceholder: true
    }))
  }),
  
  getters: {
    displayItems(state) {
      return state.list.length > 0 ? state.list : state.loading ? state.loadingPlaceholders : []
    }
  }
})
```

1. **çŠ¶æ€åºåˆ—åŒ–æ³¨æ„äº‹é¡¹**ï¼š

```js
// åºåˆ—åŒ–å‰å¤„ç† store çŠ¶æ€
function sanitizeState(state) {
  return Object.entries(state).reduce((acc, [key, value]) => {
    // ç§»é™¤å‡½æ•°ã€å¾ªç¯å¼•ç”¨ã€ç‰¹æ®Šå¯¹è±¡ç­‰ä¸å¯åºåˆ—åŒ–çš„å†…å®¹
    if (
      typeof value !== 'function' &&
      !(value instanceof Map) &&
      !(value instanceof Set) &&
      !(value instanceof Error) &&
      !(value instanceof RegExp)
    ) {
      try {
        // æµ‹è¯•æ˜¯å¦å¯åºåˆ—åŒ–
        JSON.stringify(value)
        acc[key] = value
      } catch (e) {
        // å¦‚æœä¸å¯åºåˆ—åŒ–ï¼Œåˆ™è·³è¿‡æˆ–æä¾›æ›¿ä»£å€¼
        acc[key] = null
      }
    }
    return acc
  }, {})
}

// åœ¨æœåŠ¡ç«¯æ¸²æŸ“å®Œæˆå
const sanitizedState = sanitizeState(pinia.state.value)
const state = JSON.stringify(sanitizedState)
```

1. **ä½¿ç”¨ Composition API ç»„ç»‡ Store ä»£ç **ï¼š

```js
// stores/product.js
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useProductStore = defineStore('product', () => {
  // çŠ¶æ€
  const products = ref([])
  const selectedId = ref(null)
  const loading = ref(false)
  
  // è®¡ç®—å±æ€§
  const selectedProduct = computed(() => 
    products.value.find(p => p.id === selectedId.value)
  )
  
  // åˆ†ç¦»æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ API è°ƒç”¨
  async function fetchProducts() {
    loading.value = true
    
    try {
      let data
      
      if (import.meta.env.SSR) {
        // æœåŠ¡ç«¯æ•°æ®è·å–
        const { getProducts } = await import('../server/products-api')
        data = await getProducts()
      } else {
        // å®¢æˆ·ç«¯æ•°æ®è·å–
        const res = await fetch('/api/products')
        data = await res.json()
      }
      
      products.value = data
    } catch (error) {
      console.error('Failed to fetch products:', error)
    } finally {
      loading.value = false
    }
  }
  
  function selectProduct(id) {
    selectedId.value = id
  }
  
  return {
    products,
    selectedId,
    loading,
    selectedProduct,
    fetchProducts,
    selectProduct
  }
})
```





## â¼¤å‹é¡¹â½¬ä¸­çš„ Pinia æ¨¡å—è®¾è®¡ä¸ä»£ç ç»„ç»‡ 

### åˆ†å±‚æ¶æ„è®¾è®¡

åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œå»ºè®®é‡‡ç”¨ä»¥ä¸‹åˆ†å±‚æ¶æ„è®¾è®¡ Pinia æ¨¡å—ï¼š

```
src/
â”œâ”€â”€ stores/                     # Pinia stores æ ¹ç›®å½•
â”‚   â”œâ”€â”€ index.js                # ä¸»å…¥å£ï¼Œå¯¼å‡ºåˆ›å»ºå¥½çš„ pinia å®ä¾‹
â”‚   â”œâ”€â”€ plugins/                # Pinia æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ index.js            # æ’ä»¶ä¸»å…¥å£
â”‚   â”‚   â”œâ”€â”€ persist.js          # æŒä¹…åŒ–æ’ä»¶
â”‚   â”‚   â””â”€â”€ logger.js           # æ—¥å¿—æ’ä»¶
â”‚   â”œâ”€â”€ modules/                # æŒ‰ä¸šåŠ¡æ¨¡å—ç»„ç»‡çš„ stores
â”‚   â”‚   â”œâ”€â”€ user/               # ç”¨æˆ·ç›¸å…³æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ index.js        # æ¨¡å—å…¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.js         # è®¤è¯ç›¸å…³ store
â”‚   â”‚   â”‚   â””â”€â”€ profile.js      # ç”¨æˆ·èµ„æ–™ç›¸å…³ store
â”‚   â”‚   â”œâ”€â”€ product/            # äº§å“ç›¸å…³æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ list.js         # äº§å“åˆ—è¡¨ store
â”‚   â”‚   â”‚   â””â”€â”€ detail.js       # äº§å“è¯¦æƒ… store
â”‚   â”‚   â””â”€â”€ cart/               # è´­ç‰©è½¦æ¨¡å—
â”‚   â”‚       â”œâ”€â”€ index.js
â”‚   â”‚       â””â”€â”€ cart.js         # è´­ç‰©è½¦ store
â”‚   â”œâ”€â”€ app.js                  # åº”ç”¨å…¨å±€ store
â”‚   â””â”€â”€ helpers/                # è¾…åŠ©å·¥å…·å’Œå·¥å‚å‡½æ•°
â”‚       â”œâ”€â”€ store-factory.js    # Store å·¥å‚å‡½æ•°
â”‚       â””â”€â”€ state-utils.js      # çŠ¶æ€å¤„ç†å·¥å…·å‡½æ•°
```

### å®ç°æ–¹æ¡ˆ

**1. Store æ¨¡å—åŒ–ç»„ç»‡ç¤ºä¾‹**ï¼š

js

```js
// src/stores/modules/user/auth.js
import { defineStore } from 'pinia'
import { login, logout, refreshToken } from '@/api/auth'

export const useAuthStore = defineStore('user/auth', {
  state: () => ({
    token: null,
    refreshToken: null,
    expiresAt: null,
    user: null
  }),
  
  getters: {
    isLoggedIn: (state) => !!state.token && state.expiresAt > Date.now(),
    isAdmin: (state) => state.user?.role === 'admin',
    userPermissions: (state) => state.user?.permissions || []
  },
  
  actions: {
    async login(credentials) {
      try {
        const { token, refreshToken, expiresIn, user } = await login(credentials)
        
        this.token = token
        this.refreshToken = refreshToken
        this.expiresAt = Date.now() + expiresIn * 1000
        this.user = user
        
        return true
      } catch (error) {
        this.clearAuth()
        throw error
      }
    },
    
    async logout() {
      try {
        if (this.token) {
          await logout(this.token)
        }
      } finally {
        this.clearAuth()
      }
    },
    
    async refreshAuth() {
      if (!this.refreshToken) {
        throw new Error('No refresh token available')
      }
      
      try {
        const { token, refreshToken, expiresIn } = await refreshToken(this.refreshToken)
        
        this.token = token
        this.refreshToken = refreshToken
        this.expiresAt = Date.now() + expiresIn * 1000
        
        return true
      } catch (error) {
        this.clearAuth()
        throw error
      }
    },
    
    clearAuth() {
      this.token = null
      this.refreshToken = null
      this.expiresAt = null
      this.user = null
    }
  },
  
  persist: {
    enabled: true,
    strategies: [
      {
        key: 'user-auth',
        storage: localStorage,
        paths: ['token', 'refreshToken', 'expiresAt', 'user']
      }
    ]
  }
})

// src/stores/modules/user/profile.js
import { defineStore } from 'pinia'
import { getUserProfile, updateUserProfile } from '@/api/user'
import { useAuthStore } from './auth'

export const useUserProfileStore = defineStore('user/profile', {
  state: () => ({
    profile: null,
    preferences: {
      notifications: true,
      newsletter: false,
      darkMode: false
    },
    loading: false
  }),
  
  getters: {
    fullName: (state) => {
      if (!state.profile) return ''
      return `${state.profile.firstName} ${state.profile.lastName}`
    },
    
    avatarUrl: (state) => {
      return state.profile?.avatar || '/default-avatar.png'
    }
  },
  
  actions: {
    async fetchProfile() {
      const authStore = useAuthStore()
      
      if (!authStore.isLoggedIn) {
        return null
      }
      
      this.loading = true
      
      try {
        const profile = await getUserProfile()
        this.profile = profile
        return profile
      } catch (error) {
        console.error('Failed to fetch user profile:', error)
        return null
      } finally {
        this.loading = false
      }
    },
    
    async updateProfile(profileData) {
      this.loading = true
      
      try {
        const updatedProfile = await updateUserProfile(profileData)
        this.profile = updatedProfile
        return updatedProfile
      } catch (error) {
        console.error('Failed to update profile:', error)
        throw error
      } finally {
        this.loading = false
      }
    },
    
    setPreference(key, value) {
      if (this.preferences.hasOwnProperty(key)) {
        this.preferences[key] = value
      }
    }
  },
  
  persist: {
    enabled: true,
    strategies: [
      {
        key: 'user-preferences',
        storage: localStorage,
        paths: ['preferences']
      }
    ]
  }
})

// src/stores/modules/user/index.js (æ¨¡å—å¯¼å‡º)
export { useAuthStore } from './auth'
export { useUserProfileStore } from './profile'
```





# â¾¼çº§çŠ¶æ€ç®¡ç†æ¨¡å¼

## é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD) åœ¨ Vue å‰ç«¯çŠ¶æ€ç®¡ç†ä¸­çš„åº”â½¤ 

Domain-Driven Design (DDD) principles can be effectively applied to Vue frontend state management:

- **é¢†åŸŸæ¨¡å‹éš”ç¦»**: åœ¨ Vue ä¸­åˆ›å»ºç‹¬ç«‹äº UI çš„é¢†åŸŸæ¨¡å‹ï¼ŒåŒ…å«ä¸šåŠ¡é€»è¾‘å’Œè§„åˆ™
- **æœ‰ç•Œä¸Šä¸‹æ–‡**: å°†åº”ç”¨åˆ’åˆ†ä¸ºä¸åŒçš„ä¸šåŠ¡åŸŸï¼Œæ¯ä¸ªåŸŸæœ‰è‡ªå·±çš„çŠ¶æ€ç®¡ç†æ¨¡å—
- **èšåˆæ ¹**: ä½¿ç”¨ Pinia/Vuex ä¸­çš„ store ä½œä¸ºèšåˆæ ¹ï¼Œå°è£…ç›¸å…³å®ä½“çš„æ“ä½œ
- **å€¼å¯¹è±¡å’Œå®ä½“**: åœ¨çŠ¶æ€ä¸­åŒºåˆ†å€¼å¯¹è±¡(ä¸å¯å˜)å’Œå®ä½“(æœ‰å”¯ä¸€æ ‡è¯†)
- **é¢†åŸŸäº‹ä»¶**: ä½¿ç”¨ Vue çš„äº‹ä»¶ç³»ç»Ÿæˆ– Pinia/Vuex çš„ action æ¥è¡¨ç¤ºé¢†åŸŸäº‹ä»¶
- **ä»“å‚¨æ¨¡å¼**: å°† API è°ƒç”¨æŠ½è±¡ä¸ºä»“å‚¨ï¼Œç”± store è°ƒç”¨ä½†ä¸ç›´æ¥åŒ…å«æ•°æ®è·å–é€»è¾‘



## Event Sourcing æ¨¡å¼åœ¨ Vue åº”â½¤çŠ¶æ€ç®¡ç†ä¸­çš„å®è·µ 

Event Sourcing é€šè¿‡å­˜å‚¨äº‹ä»¶åºåˆ—è€Œéæœ€ç»ˆçŠ¶æ€æ¥ç®¡ç†åº”ç”¨çŠ¶æ€:

- **äº‹ä»¶å­˜å‚¨**: æ‰€æœ‰çŠ¶æ€å˜åŒ–ä»¥äº‹ä»¶å½¢å¼å­˜å‚¨ï¼Œå¯ä»¥åœ¨ Vuex/Pinia ä¸­å®ç°äº‹ä»¶åˆ—è¡¨
- **äº‹ä»¶é‡æ”¾**: é€šè¿‡é‡æ”¾äº‹ä»¶åºåˆ—é‡å»ºåº”ç”¨çŠ¶æ€ï¼Œä¾¿äºè°ƒè¯•å’Œæ—¶é—´æ—…è¡ŒåŠŸèƒ½
- **çŠ¶æ€æ´¾ç”Ÿ**: å½“å‰çŠ¶æ€ç”±äº‹ä»¶å†å²æ´¾ç”Ÿï¼Œè€Œéç›´æ¥ä¿®æ”¹
- **å‘½ä»¤å¤„ç†å™¨**: ç”¨æˆ·æ“ä½œè½¬æ¢ä¸ºå‘½ä»¤ï¼Œç»è¿‡éªŒè¯åäº§ç”Ÿäº‹ä»¶
- **CQRS ç»“åˆ**: å°†è¯»å–(Query)ä¸å‘½ä»¤(Command)åˆ†ç¦»ï¼Œä¼˜åŒ–æ€§èƒ½
- **ä¹è§‚å¹¶å‘æ§åˆ¶**: å¤„ç†å¹¶å‘æ“ä½œå¯èƒ½å¯¼è‡´çš„å†²çª



##  Vue 3 å“åº”å¼ç³»ç»Ÿä¸å¤–éƒ¨çŠ¶æ€ç®¡ç†åº“çš„é›†æˆç­–ç•¥ 

Vue 3 å“åº”å¼ç³»ç»Ÿå¯ä¸å¤šç§å¤–éƒ¨çŠ¶æ€åº“æ— ç¼é›†æˆ:

- **Composition API æ¡¥æ¥**: ä½¿ç”¨ `provide/inject` å°†å¤–éƒ¨çŠ¶æ€æ³¨å…¥ç»„ä»¶æ ‘
- **å“åº”å¼é€‚é…å™¨**: é€šè¿‡ `reactive()` å’Œ `ref()` ä½¿å¤–éƒ¨çŠ¶æ€å“åº”å¼
- **çŠ¶æ€åŒæ­¥æœºåˆ¶**: å»ºç«‹ Vue çŠ¶æ€ä¸å¤–éƒ¨åº“çŠ¶æ€çš„åŒå‘åŒæ­¥
- **ç»„åˆå¼å‡½æ•°å°è£…**: åˆ›å»ºç»„åˆå¼å‡½æ•°(composables)å°è£…å¤–éƒ¨çŠ¶æ€é€»è¾‘
- **æ’ä»¶åŒ–é›†æˆ**: å¼€å‘ Vue æ’ä»¶ç»Ÿä¸€å¤–éƒ¨çŠ¶æ€åº“çš„ä½¿ç”¨æ–¹å¼
- **ä¸»æµåº“é›†æˆæ¨¡å¼**: MobXã€Reduxã€XState ç­‰ä¸ Vue 3 çš„å…·ä½“é›†æˆæ–¹æ³•



##  å¾®å‰ç«¯æ¶æ„ä¸‹çš„ Vue åº”â½¤çŠ¶æ€ç®¡ç†ä¸éš”ç¦» 

å¾®å‰ç«¯æ¶æ„éœ€è¦ç‰¹æ®Šçš„çŠ¶æ€ç®¡ç†ç­–ç•¥:

- **çŠ¶æ€éš”ç¦»**: ç¡®ä¿å„å¾®åº”ç”¨çŠ¶æ€äº’ä¸å¹²æ‰°ï¼Œé˜²æ­¢å‘½åå†²çª
- **å…±äº«çŠ¶æ€æœºåˆ¶**: å®ç°è·¨å¾®åº”ç”¨çš„å—æ§çŠ¶æ€å…±äº«
- **é€šä¿¡æ€»çº¿**: å»ºç«‹å¾®åº”ç”¨é—´é€šä¿¡çš„äº‹ä»¶æ€»çº¿
- **çŠ¶æ€åè°ƒæœºåˆ¶**: å¤„ç†å¤šä¸ªå¾®åº”ç”¨æ“ä½œå…±äº«çŠ¶æ€çš„å†²çª
- **ä¸»ä»åº”ç”¨å…³ç³»**: å®šä¹‰ä¸»åº”ç”¨ä¸å­åº”ç”¨é—´çš„çŠ¶æ€ç®¡ç†èŒè´£
- **çŠ¶æ€æŒä¹…åŒ–ç­–ç•¥**: ä¸åŒå¾®åº”ç”¨é—´çŠ¶æ€ä¿å­˜ä¸æ¢å¤æœºåˆ¶



## å…¨å±€çŠ¶æ€ã€â»šâ¾¯çŠ¶æ€ã€ç»„ä»¶çŠ¶æ€çš„åˆ†å±‚ç®¡ç†ç­–ç•¥ 

çŠ¶æ€åˆ†å±‚ç®¡ç†æé«˜ä»£ç ç»„ç»‡å’Œæ€§èƒ½:

- **ä¸‰å±‚çŠ¶æ€æ¨¡å‹**: æ˜ç¡®åŒºåˆ†å…¨å±€ã€é¡µé¢å’Œç»„ä»¶ä¸‰å±‚çŠ¶æ€çš„è¾¹ç•Œå’ŒèŒè´£
- **çŠ¶æ€æå‡åŸåˆ™**: ä½•æ—¶å°†çŠ¶æ€æå‡åˆ°æ›´é«˜å±‚çº§çš„å†³ç­–æ ‡å‡†
- **çŠ¶æ€ä¸‹æ²‰ç­–ç•¥**: å°†ä¸éœ€è¦å…±äº«çš„çŠ¶æ€å°½å¯èƒ½ä¿æŒåœ¨ä½å±‚çº§
- **çŠ¶æ€è®¿é—®æ§åˆ¶**: é™åˆ¶å„å±‚çº§é—´çš„çŠ¶æ€è®¿é—®æƒé™
- **ç»„ä»¶é€šä¿¡æ¨¡å¼**: ä¸åŒå±‚çº§ç»„ä»¶é—´é€šä¿¡çš„æœ€ä½³å®è·µ
- **çŠ¶æ€ç”Ÿå‘½å‘¨æœŸç®¡ç†**: é¡µé¢çº§çŠ¶æ€çš„åˆ›å»ºä¸é”€æ¯æ—¶æœºæ§åˆ¶



## åŸºäº Vue 3 å®ç°å¯è§‚å¯Ÿçš„æ•°æ®æµæ¨¡å¼ 

å¯è§‚å¯Ÿæ•°æ®æµæ¨¡å¼å¢å¼ºåº”ç”¨çš„å¯é¢„æµ‹æ€§:

- **å•å‘æ•°æ®æµ**: å®ç°ä¸¥æ ¼çš„å•å‘æ•°æ®æµï¼Œä»çŠ¶æ€åˆ°è§†å›¾
- **Observable Pattern**: åˆ©ç”¨ Vue 3 çš„ `watch` å’Œ `watchEffect` å®ç°å¯è§‚å¯Ÿæ¨¡å¼
- **æ•°æ®æµè¿½è¸ª**: é€šè¿‡ä¸­é—´ä»¶æˆ–æ’ä»¶è¿½è¸ªçŠ¶æ€å˜åŒ–
- **æ•°æ®æµè°ƒè¯•**: å¼€å‘å·¥å…·è¾…åŠ©æ•°æ®æµå¯è§†åŒ–ä¸è°ƒè¯•
- **å¼‚æ­¥æ•°æ®æµ**: å¤„ç†å¼‚æ­¥æ“ä½œçš„æ•°æ®æµæ§åˆ¶æ¨¡å¼
- **å‡½æ•°å¼æ•°æ®å¤„ç†**: ç»“åˆå‡½æ•°å¼ç¼–ç¨‹æ€æƒ³å¤„ç†æ•°æ®è½¬æ¢



## å®æ—¶åä½œåº”â½¤ä¸­çš„çŠ¶æ€åŒæ­¥ä¸å†²çªè§£å†³â½…æ¡ˆ 

å®æ—¶åä½œåº”ç”¨éœ€è¦ç‰¹æ®Šçš„çŠ¶æ€åŒæ­¥æœºåˆ¶:

- **æ“ä½œè½¬æ¢**: Operational Transformation (OT) åœ¨ Vue ä¸­çš„å®ç°
- **åˆ†å¸ƒå¼çŠ¶æ€ç®¡ç†**: å¤„ç†å¤šç”¨æˆ·åŒæ—¶ç¼–è¾‘çš„åˆ†å¸ƒå¼çŠ¶æ€
- **ä¹è§‚æ›´æ–°**: å…ˆæœ¬åœ°æ›´æ–°å†ç¡®è®¤çš„ä¹è§‚æ›´æ–°ç­–ç•¥
- **å†²çªæ£€æµ‹æœºåˆ¶**: è¯†åˆ«å¹¶æ ‡è®°çŠ¶æ€å†²çªçš„æ–¹æ³•
- **å†²çªè§£å†³ç­–ç•¥**: è‡ªåŠ¨åŒ–ä¸æ‰‹åŠ¨å†²çªè§£å†³çš„å®ç°æ–¹æ¡ˆ
- **å®æ—¶åŒæ­¥ä¸­é—´ä»¶**: WebSocket æˆ–å…¶ä»–å®æ—¶åè®®ä¸ Vue çŠ¶æ€çš„é›†æˆ





# å‰ç«¯æ¶æ„è®¾è®¡

## åŸºäº Vue 3 çš„â¼¤å‹å‰ç«¯é¡¹â½¬æ¶æ„è®¾è®¡ä¸å®è·µ 

Vue 3 å¸¦æ¥äº†ç»„åˆå¼ APIã€æ›´å¥½çš„ TypeScript æ”¯æŒå’Œæ›´å°çš„åŒ…ä½“ç§¯ï¼Œè¿™äº›ç‰¹æ€§ä½¿å…¶éå¸¸é€‚åˆæ„å»ºå¤§å‹åº”ç”¨ã€‚

### æ ¸å¿ƒæ¶æ„åŸåˆ™

- **æ¨¡å—åŒ–**: æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†æ¨¡å—ï¼Œè€ŒéæŠ€æœ¯å±‚åˆ’åˆ†
- **å¯æµ‹è¯•æ€§**: ä¸šåŠ¡é€»è¾‘ä¸ UI åˆ†ç¦»ï¼Œæ–¹ä¾¿å•å…ƒæµ‹è¯•
- **å¯æ‰©å±•æ€§**: é€šè¿‡æ’ä»¶ç³»ç»Ÿå’Œå¾®å‰ç«¯æ¶æ„å®ç°ç³»ç»Ÿæ‰©å±•
- **ä»£ç ä¸€è‡´æ€§**: ä½¿ç”¨ ESLintã€Prettier å’Œ TypeScript ç¡®ä¿ä»£ç è´¨é‡

### é¡¹ç›®ç»“æ„ç¤ºä¾‹

```
src/
â”œâ”€â”€ assets/          # é™æ€èµ„æº
â”œâ”€â”€ components/      # é€šç”¨ç»„ä»¶
â”œâ”€â”€ composables/     # ç»„åˆå¼å‡½æ•°
â”œâ”€â”€ config/          # åº”ç”¨é…ç½®
â”œâ”€â”€ directives/      # è‡ªå®šä¹‰æŒ‡ä»¤
â”œâ”€â”€ layouts/         # å¸ƒå±€ç»„ä»¶
â”œâ”€â”€ modules/         # æŒ‰ä¸šåŠ¡åˆ’åˆ†çš„æ¨¡å—
â”‚   â”œâ”€â”€ module1/
â”‚   â”‚   â”œâ”€â”€ api/     # æ¨¡å—API
â”‚   â”‚   â”œâ”€â”€ components/ # æ¨¡å—ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ composables/ # æ¨¡å—ç»„åˆå¼å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ routes/  # æ¨¡å—è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ store/   # æ¨¡å—çŠ¶æ€ç®¡ç†
â”‚   â”‚   â””â”€â”€ views/   # æ¨¡å—é¡µé¢
â”‚   â””â”€â”€ module2/
â”œâ”€â”€ plugins/         # æ’ä»¶
â”œâ”€â”€ router/          # è·¯ç”±é…ç½®
â”œâ”€â”€ services/        # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ api/         # APIæœåŠ¡
â”‚   â”œâ”€â”€ auth/        # è®¤è¯æœåŠ¡
â”‚   â””â”€â”€ storage/     # å­˜å‚¨æœåŠ¡
â”œâ”€â”€ store/           # Pinia çŠ¶æ€ç®¡ç†
â”œâ”€â”€ utils/           # å·¥å…·å‡½æ•°
â””â”€â”€ App.vue          # æ ¹ç»„ä»¶
```



## ä¸­åå°ç³»ç»Ÿçš„æ¨¡å—åŒ–è®¾è®¡ä¸æƒé™æ§åˆ¶å®ç° 

### æ¨¡å—åŒ–è®¾è®¡

ä¸­åå°ç³»ç»Ÿé€šå¸¸åŠŸèƒ½å¤šæ ·ä¸”å¤æ‚ï¼Œéœ€è¦è‰¯å¥½çš„æ¨¡å—åŒ–è®¾è®¡ï¼š

- **æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†æ¨¡å—**ï¼šå¦‚ç”¨æˆ·ç®¡ç†ã€è®¢å•ç®¡ç†ã€å•†å“ç®¡ç†ç­‰
- **æ¨¡å—è‡ªæ²»**ï¼šæ¯ä¸ªæ¨¡å—åŒ…å«è‡ªå·±çš„ç»„ä»¶ã€è·¯ç”±ã€çŠ¶æ€ç®¡ç†ç­‰èµ„æº
- **æ¨¡å—é—´é€šä¿¡**ï¼šé€šè¿‡äº‹ä»¶æ€»çº¿æˆ–çŠ¶æ€ç®¡ç†å®ç°

### æƒé™æ§åˆ¶å®ç°

æƒé™æ§åˆ¶é€šå¸¸åˆ†ä¸ºå‡ ä¸ªå±‚æ¬¡ï¼š

1. **è·¯ç”±æƒé™**ï¼šæ§åˆ¶é¡µé¢è®¿é—®

```js
// è·¯ç”±å®ˆå«
router.beforeEach((to, from, next) => {
  const { permissions } = useUserStore();
  
  if (to.meta.requiredPermissions) {
    const hasPermission = checkPermissions(permissions, to.meta.requiredPermissions);
    if (!hasPermission) {
      next({ path: '/403' });
      return;
    }
  }
  next();
});
```

1. **ç»„ä»¶æƒé™**ï¼šæ§åˆ¶ç»„ä»¶æ¸²æŸ“

```vue
<template>
  <v-permission :permission="'user:create'">
    <button>åˆ›å»ºç”¨æˆ·</button>
  </v-permission>
</template>
```

1. **API æƒé™**ï¼šæ§åˆ¶æ¥å£è®¿é—®

```js
// è¯·æ±‚æ‹¦æˆªå™¨
axiosInstance.interceptors.request.use(config => {
  // æ·»åŠ æƒé™è®¤è¯ä¿¡æ¯
  config.headers.Authorization = `Bearer ${getToken()}`;
  return config;
});

// å“åº”æ‹¦æˆªå™¨
axiosInstance.interceptors.response.use(
  response => response,
  error => {
    if (error.response.status === 401) {
      // å¤„ç†æœªæˆæƒ
      router.push('/login');
    }
    if (error.response.status === 403) {
      // å¤„ç†æƒé™ä¸è¶³
      router.push('/403');
    }
    return Promise.reject(error);
  }
);
```



## Vue åº”â½¤çš„åˆ†å±‚æ¶æ„ï¼šè§†å›¾å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€æ•°æ®å±‚çš„æ¸…æ™°åˆ†ç¦» 

### è§†å›¾å±‚ (View)

åŒ…å« Vue ç»„ä»¶ï¼Œåªè´Ÿè´£ UI æ¸²æŸ“å’Œç”¨æˆ·äº¤äº’ã€‚

```vue
<template>
  <div>
    <user-list :users="users" @edit="editUser" />
    <loading-indicator v-if="loading" />
  </div>
</template>

<script setup>
import { useUsers } from '@/composables/useUsers';

const { users, loading, fetchUsers, editUser } = useUsers();

onMounted(fetchUsers);
</script>
```

### ä¸šåŠ¡é€»è¾‘å±‚ (BLL)

ä½¿ç”¨ Vue 3 çš„ç»„åˆå¼å‡½æ•°å®ç°ä¸šåŠ¡é€»è¾‘ï¼š

```js
// composables/useUsers.js
export function useUsers() {
  const users = ref([]);
  const loading = ref(false);
  const userService = useUserService();
  
  async function fetchUsers() {
    loading.value = true;
    try {
      users.value = await userService.getUsers();
    } catch (error) {
      // é”™è¯¯å¤„ç†
    } finally {
      loading.value = false;
    }
  }
  
  function editUser(userId) {
    // ç¼–è¾‘ç”¨æˆ·é€»è¾‘
  }
  
  return { users, loading, fetchUsers, editUser };
}
```

### æ•°æ®å±‚ (DAL)

è´Ÿè´£ä¸åç«¯ API é€šä¿¡å’Œæ•°æ®å¤„ç†ï¼š

```js
// services/userService.js
export function useUserService() {
  const apiClient = useApiClient();
  
  async function getUsers() {
    const response = await apiClient.get('/users');
    return response.data;
  }
  
  async function updateUser(id, userData) {
    const response = await apiClient.put(`/users/${id}`, userData);
    return response.data;
  }
  
  return { getUsers, updateUser };
}
```



## API ä¸­é—´å±‚è®¾è®¡ä¸å®ç°ï¼Œå¤„ç†å¤æ‚çš„å‰åç«¯äº¤äº’ 

API ä¸­é—´å±‚ä½œä¸ºå‰ç«¯å’Œåç«¯ API çš„æ¡¥æ¢ï¼Œå¯ä»¥è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

- æ¥å£é€‚é…ï¼šå¤„ç†åç«¯æ¥å£ä¸å‰ç«¯éœ€æ±‚çš„ä¸åŒ¹é…
- æ•°æ®è½¬æ¢ï¼šè§„èŒƒåŒ–å’Œæ ‡å‡†åŒ– API å“åº”
- é”™è¯¯å¤„ç†ï¼šç»Ÿä¸€å¤„ç† HTTP é”™è¯¯
- ç¼“å­˜æ§åˆ¶ï¼šå®ç°å‰ç«¯æ•°æ®ç¼“å­˜ç­–ç•¥

### å®ç°ç¤ºä¾‹

```js
// services/api/apiClient.js
import axios from 'axios';
import { useCacheService } from '../cache/cacheService';

export function createApiClient(baseURL, options = {}) {
  const instance = axios.create({
    baseURL,
    timeout: options.timeout || 10000,
    headers: {
      'Content-Type': 'application/json',
      ...options.headers
    }
  });
  
  // è¯·æ±‚è½¬æ¢å™¨
  instance.interceptors.request.use(config => {
    // æ·»åŠ è®¤è¯ä¿¡æ¯
    if (options.auth) {
      config.headers.Authorization = `Bearer ${options.auth.getToken()}`;
    }
    
    // æ”¯æŒç¼“å­˜
    if (config.cache) {
      const cacheService = useCacheService();
      const cachedData = cacheService.get(getCacheKey(config));
      if (cachedData) {
        // å–æ¶ˆè¯·æ±‚ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®
        config.adapter = () => {
          return Promise.resolve({
            data: cachedData,
            status: 200,
            statusText: 'OK',
            headers: {},
            config,
            isCached: true
          });
        };
      }
    }
    
    return config;
  });
  
  // å“åº”è½¬æ¢å™¨
  instance.interceptors.response.use(
    response => {
      // ç¼“å­˜å“åº”
      if (response.config.cache && !response.isCached) {
        const cacheService = useCacheService();
        cacheService.set(
          getCacheKey(response.config),
          response.data,
          response.config.cacheTime || 5 * 60 * 1000
        );
      }
      
      // æ•°æ®é€‚é…è½¬æ¢
      if (options.responseTransformer) {
        return options.responseTransformer(response);
      }
      
      return response;
    },
    error => {
      // é”™è¯¯å¤„ç†
      if (options.errorHandler) {
        return options.errorHandler(error);
      }
      
      return Promise.reject(error);
    }
  );
  
  return instance;
}

function getCacheKey(config) {
  return `${config.url}:${JSON.stringify(config.params || {})}`;
}
```

### ä½¿ç”¨ç¤ºä¾‹

```js
// services/api/userApi.js
import { createApiClient } from './apiClient';
import { authService } from '../auth/authService';

const apiClient = createApiClient('/api/v1', {
  auth: authService,
  errorHandler: error => {
    if (error.response && error.response.status === 401) {
      authService.redirectToLogin();
      return Promise.reject(error);
    }
    return Promise.reject(error);
  }
});

export const userApi = {
  getUsers(params, options = {}) {
    return apiClient.get('/users', {
      params,
      cache: options.cache || false,
      cacheTime: options.cacheTime || 2 * 60 * 1000 // 2åˆ†é’Ÿç¼“å­˜
    });
  }
};
```



## å¦‚ä½•è®¾è®¡â¼€ä¸ªå¯æ‰©å±•çš„ Vue æ’ä»¶ç³»ç»Ÿ 

Vue æ’ä»¶ç³»ç»Ÿå…è®¸å‘åº”ç”¨ç¨‹åºæ·»åŠ å…¨å±€çº§åŠŸèƒ½ï¼Œä¸€ä¸ªå¥½çš„æ’ä»¶ç³»ç»Ÿåº”è¯¥ï¼š

- æ¨¡å—åŒ–ï¼šæ¯ä¸ªæ’ä»¶æœ‰æ˜ç¡®çš„èŒè´£
- å¯é…ç½®ï¼šæ’ä»¶å¯ä»¥é€šè¿‡é€‰é¡¹è¿›è¡Œé…ç½®
- å¯ç»„åˆï¼šæ’ä»¶ä¹‹é—´å¯ä»¥ååŒå·¥ä½œ
- å¯æ‰©å±•ï¼šæ ¸å¿ƒåŠŸèƒ½å¯ä»¥é€šè¿‡æ’ä»¶æ‰©å±•

### æ’ä»¶ç³»ç»Ÿè®¾è®¡

```js
// plugins/index.js
import { createApp } from 'vue';

export class PluginSystem {
  constructor(app) {
    this.app = app;
    this.plugins = new Map();
    this.hooks = {};
  }

  // æ³¨å†Œæ’ä»¶
  use(plugin, options = {}) {
    if (this.plugins.has(plugin.name)) {
      console.warn(`Plugin "${plugin.name}" is already registered.`);
      return this;
    }

    // åˆå§‹åŒ–æ’ä»¶
    const instance = plugin.install(this.app, options, this);
    this.plugins.set(plugin.name, { instance, options });

    return this;
  }

  // è·å–æ’ä»¶å®ä¾‹
  getPlugin(name) {
    const plugin = this.plugins.get(name);
    if (!plugin) {
      console.warn(`Plugin "${name}" is not registered.`);
      return null;
    }
    return plugin.instance;
  }

  // æ·»åŠ é’©å­
  addHook(name, callback) {
    if (!this.hooks[name]) {
      this.hooks[name] = [];
    }
    this.hooks[name].push(callback);
    return this;
  }

  // è°ƒç”¨é’©å­
  callHook(name, ...args) {
    const hooks = this.hooks[name] || [];
    return Promise.all(hooks.map(hook => hook(...args)));
  }
}

// åˆ›å»ºæ’ä»¶ç³»ç»Ÿ
export function createPluginSystem(app) {
  return new PluginSystem(app);
}
```

### æ’ä»¶å®ç°ç¤ºä¾‹

```js
// plugins/i18n.js
export const i18nPlugin = {
  name: 'i18n',
  install(app, options, pluginSystem) {
    const i18n = {
      locale: options.locale || 'en',
      messages: options.messages || {},
      
      setLocale(locale) {
        this.locale = locale;
        // è§¦å‘è¯­è¨€åˆ‡æ¢é’©å­
        pluginSystem.callHook('i18n:localeChanged', locale);
      },
      
      t(key) {
        const messages = this.messages[this.locale] || {};
        return messages[key] || key;
      }
    };
    
    // æ³¨å†Œå…¨å±€å±æ€§
    app.config.globalProperties.$i18n = i18n;
    app.config.globalProperties.$t = key => i18n.t(key);
    
    // æä¾›æ³¨å…¥
    app.provide('i18n', i18n);
    
    return i18n;
  }
};
```

### ä½¿ç”¨ç¤ºä¾‹

```js
// main.js
import { createApp } from 'vue';
import App from './App.vue';
import { createPluginSystem } from './plugins';
import { i18nPlugin } from './plugins/i18n';
import { authPlugin } from './plugins/auth';

const app = createApp(App);
const plugins = createPluginSystem(app);

// æ³¨å†Œæ’ä»¶
plugins.use(i18nPlugin, {
  locale: 'zh-CN',
  messages: {
    'zh-CN': {
      hello: 'ä½ å¥½ï¼Œä¸–ç•Œï¼'
    },
    'en': {
      hello: 'Hello, world!'
    }
  }
});

// æ’ä»¶å¯ä»¥ååŒå·¥ä½œ
plugins.use(authPlugin, {
  onLogin: async (user) => {
    // ç”¨æˆ·ç™»å½•ååŠ è½½å¯¹åº”è¯­è¨€
    const i18n = plugins.getPlugin('i18n');
    if (user.preferredLanguage) {
      i18n.setLocale(user.preferredLanguage);
    }
  }
});

// æ·»åŠ é’©å­
plugins.addHook('i18n:localeChanged', (locale) => {
  console.log(`è¯­è¨€å·²åˆ‡æ¢åˆ° ${locale}`);
});

app.mount('#app');
```



## å‰ç«¯å›½é™…åŒ–è§£å†³â½…æ¡ˆçš„æ¶æ„è®¾è®¡ä¸å®ç° 

å›½é™…åŒ–ï¼ˆi18nï¼‰æ˜¯å¤§å‹åº”ç”¨å¿…å¤‡çš„åŠŸèƒ½ï¼ŒVue 3 å¯ä»¥ç»“åˆä¸“ä¸šçš„ i18n åº“å®ç°å®Œæ•´çš„å›½é™…åŒ–æ–¹æ¡ˆã€‚

### æ¶æ„è®¾è®¡

ä¸€ä¸ªå®Œæ•´çš„å›½é™…åŒ–æ–¹æ¡ˆåº”åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

- **ç¿»è¯‘ç®¡ç†**ï¼šå­˜å‚¨å’ŒåŠ è½½ç¿»è¯‘æ–‡ä»¶
- **è¯­è¨€åˆ‡æ¢**ï¼šåŠ¨æ€åˆ‡æ¢å½“å‰è¯­è¨€
- **æ—¥æœŸã€æ•°å­—å’Œè´§å¸æ ¼å¼åŒ–**ï¼šæ ¹æ®åœ°åŒºæ˜¾ç¤ºä¸åŒæ ¼å¼
- **å¤æ•°å’Œæ€§åˆ«å¤„ç†**ï¼šå¤„ç†ä¸åŒè¯­è¨€çš„è¯­æ³•è§„åˆ™
- **æŒ‰éœ€åŠ è½½**ï¼šå»¶è¿ŸåŠ è½½ä¸å¸¸ç”¨çš„ç¿»è¯‘ä»¥å‡å°‘åˆå§‹åŠ è½½ä½“ç§¯

### åŸºäº Vue I18n çš„å®ç°

```js
// plugins/i18n/index.js
import { createI18n } from 'vue-i18n';
import { nextTick } from 'vue';

// é¢„åŠ è½½çš„è¯­è¨€
import en from './locales/en.json';
import zhCN from './locales/zh-CN.json';

export const SUPPORT_LOCALES = ['en', 'zh-CN', 'ja', 'ko'];

export function setupI18n(options = { locale: 'en' }) {
  const i18n = createI18n({
    legacy: false, // ä½¿ç”¨ Composition API
    globalInjection: true, // å…¨å±€æ³¨å…¥ $t, $d, $n
    locale: options.locale,
    fallbackLocale: 'en',
    messages: {
      en,
      'zh-CN': zhCN
    },
    datetimeFormats: {
      'en': {
        short: {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        }
      },
      'zh-CN': {
        short: {
          year: 'numeric',
          month: 'numeric',
          day: 'numeric'
        }
      }
    },
    numberFormats: {
      'en': {
        currency: {
          style: 'currency',
          currency: 'USD'
        }
      },
      'zh-CN': {
        currency: {
          style: 'currency',
          currency: 'CNY'
        }
      }
    }
  });

  setI18nLanguage(i18n, options.locale);
  
  return i18n;
}

// åˆ‡æ¢è¯­è¨€
export async function setI18nLanguage(i18n, locale) {
  if (i18n.mode === 'legacy') {
    i18n.global.locale = locale;
  } else {
    i18n.global.locale.value = locale;
  }
  
  // è®¾ç½® HTML lang å±æ€§
  document.querySelector('html').setAttribute('lang', locale);
  
  // åŠ è½½è¯­è¨€åŒ…
  await loadLocaleMessages(i18n, locale);
}

// åŠ¨æ€åŠ è½½è¯­è¨€åŒ…
export async function loadLocaleMessages(i18n, locale) {
  // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
  const messages = i18n.global.getLocaleMessage(locale);
  if (Object.keys(messages).length > 0) return;
  
  // åŠ¨æ€å¯¼å…¥è¯­è¨€åŒ…
  try {
    const messages = await import(`./locales/${locale}.json`);
    i18n.global.setLocaleMessage(locale, messages.default);
  } catch (error) {
    console.error(`Failed to load locale: ${locale}`, error);
  }
  
  return nextTick();
}
```

### è·¯ç”±å›½é™…åŒ–ç¤ºä¾‹

```js
// router/index.js
import { createRouter, createWebHistory } from 'vue-router';
import { setupI18n, setI18nLanguage, loadLocaleMessages, SUPPORT_LOCALES } from '../plugins/i18n';

export function createI18nRouter(i18n) {
  const router = createRouter({
    history: createWebHistory(),
    routes: [
      {
        path: '/:locale/',
        component: {
          template: '<router-view></router-view>'
        },
        children: [
          {
            path: '',
            name: 'home',
            component: () => import('../views/Home.vue')
          },
          {
            path: 'about',
            name: 'about',
            component: () => import('../views/About.vue')
          }
        ],
        beforeEnter: async (to, from, next) => {
          const paramsLocale = to.params.locale;
          
          // æ£€æŸ¥æ˜¯å¦æ”¯æŒè¯¥è¯­è¨€
          if (!SUPPORT_LOCALES.includes(paramsLocale)) {
            return next(`/${i18n.global.locale.value}`);
          }
          
          // è®¾ç½® i18n è¯­è¨€
          await setI18nLanguage(i18n, paramsLocale);
          
          return next();
        }
      },
      {
        // é‡å®šå‘åˆ°æµè§ˆå™¨é¦–é€‰è¯­è¨€
        path: '/',
        redirect: () => {
          const locale = navigator.language.split('-')[0] || 'en';
          return `/${SUPPORT_LOCALES.includes(locale) ? locale : 'en'}`;
        }
      }
    ]
  });
  
  return router;
}
```

### ç»„ä»¶ä¸­ä½¿ç”¨

```vue
<template>
  <div>
    <!-- ä½¿ç”¨ç¿»è¯‘ -->
    <h1>{{ $t('welcome') }}</h1>
    <p>{{ $t('description') }}</p>
    
    <!-- æ—¥æœŸæ ¼å¼åŒ– -->
    <p>{{ $d(new Date(), 'short') }}</p>
    
    <!-- è´§å¸æ ¼å¼åŒ– -->
    <p>{{ $n(1000, 'currency') }}</p>
    
    <!-- è¯­è¨€åˆ‡æ¢ -->
    <select v-model="currentLocale" @change="changeLocale">
      <option v-for="locale in availableLocales" :key="locale" :value="locale">
        {{ locale }}
      </option>
    </select>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { useI18n } from 'vue-i18n';
import { useRouter } from 'vue-router';
import { SUPPORT_LOCALES } from '../plugins/i18n';

const { locale } = useI18n();
const router = useRouter();
const currentLocale = computed(() => locale.value);
const availableLocales = SUPPORT_LOCALES;

function changeLocale(event) {
  const newLocale = event.target.value;
  router.push({
    params: { ...router.currentRoute.value.params, locale: newLocale }
  });
}
</script>
```



## å¾®æœåŠ¡å‰ç«¯çš„è®¾è®¡ç†å¿µä¸ Vue å®è·µ

å¾®æœåŠ¡å‰ç«¯ï¼ˆMicro-Frontendï¼‰æ˜¯ä¸€ç§å°†å‰ç«¯åº”ç”¨æ‹†åˆ†æˆæ›´å°ã€æ›´å¯ç®¡ç†éƒ¨åˆ†çš„æ¶æ„æ¨¡å¼ï¼Œæ¯ä¸ªéƒ¨åˆ†å¯ä»¥ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²ã€‚

### è®¾è®¡ç†å¿µ

- **ç‹¬ç«‹éƒ¨ç½²**ï¼šæ¯ä¸ªå¾®å‰ç«¯éƒ½å¯ä»¥ç‹¬ç«‹æ„å»ºå’Œéƒ¨ç½²
- **æŠ€æœ¯æ ˆæ— å…³**ï¼šä¸åŒå¾®å‰ç«¯å¯ä»¥ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆ
- **å›¢é˜Ÿè‡ªæ²»**ï¼šä¸åŒå›¢é˜Ÿå¯ä»¥è´Ÿè´£ä¸åŒçš„å¾®å‰ç«¯
- **éš”ç¦»æ€§**ï¼šå¾®å‰ç«¯é—´çš„ä»£ç ã€æ ·å¼ã€çŠ¶æ€ç›¸äº’éš”ç¦»
- **é€šä¿¡æœºåˆ¶**ï¼šå¾®å‰ç«¯é—´å¯ä»¥å®‰å…¨åœ°è¿›è¡Œé€šä¿¡

### åŸºäº Vue çš„å¾®å‰ç«¯å®ç°æ–¹å¼

#### 1. ä½¿ç”¨æ¨¡å—è”é‚¦ï¼ˆModule Federationï¼‰

Webpack 5 çš„æ¨¡å—è”é‚¦å…è®¸å¤šä¸ªç‹¬ç«‹æ„å»ºå½¢æˆä¸€ä¸ªç»Ÿä¸€çš„åº”ç”¨ç¨‹åºã€‚

```js
// webpack.config.js (å®¿ä¸»åº”ç”¨)
const { ModuleFederationPlugin } = require('webpack').container;

module.exports = {
  // ...
  plugins: [
    new ModuleFederationPlugin({
      name: 'host',
      filename: 'remoteEntry.js',
      remotes: {
        app1: 'app1@http://localhost:8081/remoteEntry.js',
        app2: 'app2@http://localhost:8082/remoteEntry.js'
      },
      shared: ['vue']
    })
  ]
};
```

js

```js
// åœ¨ä¸»åº”ç”¨ä¸­åŠ è½½å¾®å‰ç«¯
const App1 = defineAsyncComponent(() => import('app1/App'));
const App2 = defineAsyncComponent(() => import('app2/App'));
```

#### 2. åŸºäºè·¯ç”±çš„å¾®å‰ç«¯

æ¯ä¸ªåº”ç”¨è´Ÿè´£ä¸åŒçš„è·¯ç”±è·¯å¾„ï¼š

```js
// ä¸»åº”ç”¨è·¯ç”±
const router = createRouter({
  history: createWebHistory(),
  routes: [
    {
      path: '/',
      component: Home
    },
    {
      path: '/app1',
      component: {
        render() {
          return h('div', { id: 'app1-container' });
        },
        mounted() {
          // åŠ¨æ€åŠ è½½å¾®å‰ç«¯
          loadMicroApp({
            name: 'app1',
            entry: '//localhost:8081',
            container: '#app1-container'
          });
        }
      }
    }
  ]
});
```

#### 3. å¾®å‰ç«¯é€šä¿¡

å¾®å‰ç«¯é—´é€šä¿¡å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. **URL å‚æ•°**ï¼šé€šè¿‡ URL ä¼ é€’ç®€å•çŠ¶æ€
2. **è‡ªå®šä¹‰äº‹ä»¶**ï¼šä½¿ç”¨æµè§ˆå™¨çš„äº‹ä»¶ç³»ç»Ÿè¿›è¡Œé€šä¿¡

```js
// å‘é€äº‹ä»¶
window.dispatchEvent(new CustomEvent('micro-event', {
  detail: { type: 'userLogin', data: { userId: 123 } }
}));

// æ¥æ”¶äº‹ä»¶
window.addEventListener('micro-event', (event) => {
  if (event.detail.type === 'userLogin') {
    // å¤„ç†ç”¨æˆ·ç™»å½•äº‹ä»¶
  }
});
```

1. **å…±äº«çŠ¶æ€åº“**ï¼šä½¿ç”¨å…±äº«çš„çŠ¶æ€ç®¡ç†

```js
// åˆ›å»ºå…±äº«çŠ¶æ€
import { createPinia } from 'pinia';

const sharedPinia = createPinia();
window.__SHARED_PINIA__ = sharedPinia;

// åœ¨å¾®å‰ç«¯ä¸­ä½¿ç”¨
import { createApp } from 'vue';
import App from './App.vue';
import { createPinia } from 'pinia';

const app = createApp(App);
app.use(window.__SHARED_PINIA__ || createPinia());
```

### å¾®å‰ç«¯æ¶æ„çš„å…³é”®è€ƒè™‘å› ç´ 

1. **æ ·å¼éš”ç¦»**ï¼šä½¿ç”¨ CSS Modulesã€Shadow DOM æˆ– CSS-in-JS æŠ€æœ¯
2. **ä¾èµ–å…±äº«**ï¼šå…±äº«æ ¸å¿ƒåº“ä»¥å‡å°‘é‡å¤åŠ è½½
3. **ç‰ˆæœ¬æ§åˆ¶**ï¼šå¾®å‰ç«¯æ¥å£çš„ç‰ˆæœ¬ç®¡ç†
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæŒ‰éœ€åŠ è½½å¾®å‰ç«¯ï¼Œé¿å…åˆå§‹åŠ è½½è¿‡å¤§
5. **ç»Ÿä¸€ä½“éªŒ**ï¼šå…±äº«è®¾è®¡ç³»ç»Ÿå’Œç»„ä»¶åº“

